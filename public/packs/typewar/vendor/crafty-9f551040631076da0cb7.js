!function(t){function e(n){if(i[n])return i[n].exports;var r=i[n]={i:n,l:!1,exports:{}};return t[n].call(r.exports,r,r.exports,e),r.l=!0,r.exports}var i={};e.m=t,e.c=i,e.i=function(t){return t},e.d=function(t,i,n){e.o(t,i)||Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:n})},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=100)}({100:function(t,e,i){var n,n,r,s,o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};!function t(e,i,r){function s(a,h){if(!i[a]){if(!e[a]){var u="function"==typeof n&&n;if(!h&&u)return n(a,!0);if(o)return o(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var l=i[a]={exports:{}};e[a][0].call(l.exports,function(t){var i=e[a][1][t];return s(i||t)},l,l.exports,t,e,i,r)}return i[a].exports}for(var o="function"==typeof n&&n,a=0;a<r.length;a++)s(r[a]);return s}({1:[function(t,e,i){function n(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function s(t){if(l===setTimeout)return setTimeout(t,0);if((l===n||!l)&&setTimeout)return l=setTimeout,setTimeout(t,0);try{return l(t,0)}catch(e){try{return l.call(null,t,0)}catch(e){return l.call(this,t,0)}}}function o(t){if(d===clearTimeout)return clearTimeout(t);if((d===r||!d)&&clearTimeout)return d=clearTimeout,clearTimeout(t);try{return d(t)}catch(e){try{return d.call(null,t)}catch(e){return d.call(this,t)}}}function a(){g&&p&&(g=!1,p.length?f=p.concat(f):m=-1,f.length&&h())}function h(){if(!g){var t=s(a);g=!0;for(var e=f.length;e;){for(p=f,f=[];++m<e;)p&&p[m].run();m=-1,e=f.length}p=null,g=!1,o(t)}}function u(t,e){this.fun=t,this.array=e}function c(){}var l,d,_=e.exports={};!function(){try{l="function"==typeof setTimeout?setTimeout:n}catch(t){l=n}try{d="function"==typeof clearTimeout?clearTimeout:r}catch(t){d=r}}();var p,f=[],g=!1,m=-1;_.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];f.push(new u(t,e)),1!==f.length||g||s(h)},u.prototype.run=function(){this.fun.apply(null,this.array)},_.title="browser",_.browser=!0,_.env={},_.argv=[],_.version="",_.versions={},_.on=c,_.addListener=c,_.once=c,_.off=c,_.removeListener=c,_.removeAllListeners=c,_.emit=c,_.binding=function(t){throw new Error("process.binding is not supported")},_.cwd=function(){return"/"},_.chdir=function(t){throw new Error("process.chdir is not supported")},_.umask=function(){return 0}},{}],2:[function(t,e,i){function n(t,e,i){Object.defineProperty(t,e,{enumerable:!1,configurable:!1,get:function(){return t[i]},set:function(e){t[i]=e}})}e.exports={defineAliases:function(t){n(t,"image_whitelist","imageWhitelist")}}},{}],3:[function(t,e,i){function n(t){o.mouseObjs++,this.button=t}function r(t){this.key=t}function s(t){this.inputs=t}var o=t("../core/core.js");n.prototype={isDown:function(){return o.mouseButtonsDown[this.button]},destroy:function(){o.mouseObjs--}},r.prototype={isDown:function(){return o.keydown[this.key]}},s.prototype={timeDown:null,isActive:function(){for(var t in this.inputs){if(this.inputs[t].isDown())return this.timeDown||(this.timeDown=Date.now()),!0}return delete this.timeDown,!1},destroy:function(){for(var t in this.inputs)"function"==typeof this.inputs[t].destroy&&this.inputs[t].destroy()}},o.s("Controls",{init:function(){this._dpads={},this._triggers={}},events:{EnterFrameInput:function(){this.runEvents()},KeyDown:function(){this.updateTriggers()},KeyUp:function(){this.updateTriggers()},MouseDown:function(t){this.updateTriggers()},MouseUp:function(t){this.updateTriggers()}},updateTriggers:function(t){for(var e in this._triggers){var i=this._triggers[e];this.updateTriggerInput(i)}},runEvents:function(){for(var t in this._dpads){var e=this._dpads[t];e.oldX=e.x,e.oldY=e.y,this.updateDpadInput(e,e.multipleDirectionBehavior),this.updateActiveDirection(e,e.normalize),e.event.x=e.x,e.event.y=e.y,e.x===e.oldX&&e.y===e.oldY||o.trigger("DirectionalInput",e.event)}},getDpad:function(t){return this._dpads[t]},isTriggerDown:function(t){return this._triggers[t].active},defineTriggerGroup:function(t,e){var i;if(Array.isArray(e))i=e;else{if(i=[],e.mouseButtons)for(var o in e.mouseButtons)i.push(new n(e.mouseButtons[o]));if(e.keys)for(var a in e.keys)i.push(new r(e.keys[a]))}this._triggers[t]&&this._triggers[t].input.destroy(),this._triggers[t]={name:t,input:new s(i),downFor:0,active:!1}},defineDpad:function(t,e,i){var n={};for(var a in e){var h=e[a],u=o.keys[a]||a;n[h]||(n[h]=[]),n[h].push(new r(u))}var c={};for(var l in n)c[l]={input:new s(n[l]),active:!1,n:this.parseDirection(l)};if(void 0===i&&(i={}),void 0===i.normalize&&(i.normalize=!1),void 0===i.multipleDirectionBehavior&&(i.multipleDirectionBehavior="all"),this._dpads[t]){for(l in this._dpads[t].parsedDefinition)this._dpads[t].parsedDefinition[l].input.destroy();delete this._dpads[t]}this._dpads[t]={name:t,directions:c,x:0,y:0,oldX:0,oldY:0,event:{x:0,y:0,name:t},normalize:i.normalize,multipleDirectionBehavior:i.multipleDirectionBehavior}},parseDirection:function(t){return{x:Math.round(1e3*Math.cos(t*(Math.PI/180)))/1e3,y:Math.round(1e3*Math.sin(t*(Math.PI/180)))/1e3}},updateActiveDirection:function(t,e){t.x=0,t.y=0;for(var i in t.directions){var n=t.directions[i];n.active&&(t.x+=n.n.x,t.y+=n.n.y)}if(e){var r=Math.sqrt(t.x*t.x+t.y*t.y);r>0&&(t.x=t.x/r,t.y=t.y/r)}},updateTriggerInput:function(t){t.active?t.input.isActive()||(t.active=!1,o.trigger("TriggerInputUp",t),t.downFor=0):t.input.isActive()&&(t.downFor=Date.now()-t.input.timeDown,t.active=!0,o.trigger("TriggerInputDown",t))},updateDpadInput:function(t,e){var i,n,r;for(i in t.directions)n=t.directions[i],n.active=!1,n.input.isActive()&&("all"===e?n.active=!0:r?("first"===e&&r.input.timeDown>n.input.timeDown&&(r=n),"last"===e&&r.input.timeDown<n.input.timeDown&&(r=n)):r=n);r&&(r.active=!0)}})},{"../core/core.js":9}],4:[function(t,e,i){var n=t("../core/core.js");n.c("Draggable",{_origX:null,_origY:null,_oldX:null,_oldY:null,_dir:null,init:function(){this.requires("MouseDrag"),this.bind("StartDrag",this._startDrag).bind("Dragging",this._drag)},remove:function(){this.unbind("StartDrag",this._startDrag).unbind("Dragging",this._drag)},enableDrag:function(){return this.uniqueBind("Dragging",this._drag),this},disableDrag:function(){return this.unbind("Dragging",this._drag),this},dragDirection:function(t){if(void 0===t)this._dir=null;else if(+t===t)this._dir={x:Math.cos(t/180*Math.PI),y:Math.sin(t/180*Math.PI)};else if(0===t.x&&0===t.y)this._dir={x:0,y:0};else{var e=Math.sqrt(t.x*t.x+t.y*t.y);this._dir={x:t.x/e,y:t.y/e}}return this},_startDrag:function(t){this._origX=t.realX,this._origY=t.realY,this._oldX=this._x,this._oldY=this._y},_drag:function(t){if(this._dir){if(0!==this._dir.x||0!==this._dir.y){var e=(t.realX-this._origX)*this._dir.x+(t.realY-this._origY)*this._dir.y;this.x=this._oldX+e*this._dir.x,this.y=this._oldY+e*this._dir.y}}else this.x=this._oldX+(t.realX-this._origX),this.y=this._oldY+(t.realY-this._origY)}}),n.c("Controllable",{init:function(){this._inputBindings={DirectionalInput:{},TriggerInputDown:{},TriggerInputUp:{}}},events:{DirectionalInput:function(t){this._inputBindings.DirectionalInput[t.name]&&this._inputBindings.DirectionalInput[t.name].call(this,t)},TriggerInputDown:function(t){this._inputBindings.TriggerInputDown[t.name]&&this._inputBindings.TriggerInputDown[t.name].call(this,t)},TriggerInputUp:function(t){this._inputBindings.TriggerInputUp[t.name]&&this._inputBindings.TriggerInputUp[t.name].call(this,t)}},linkInput:function(t,e,i){this._inputBindings[t][e]=i},unlinkInput:function(t,e){delete this._inputBindings[t][e]},disableControls:!1,enableControl:function(){return this.disableControls=!1,this},disableControl:function(){return this.disableControls=!0,this}}),n.c("Multiway",{_speed:null,init:function(){this.requires("Motion, Controllable"),this._dpadName="MultiwayDpad"+this[0],this._speed={x:150,y:150},this._direction={x:0,y:0}},remove:function(){this.disableControls||(this.vx=this.vy=0)},events:{EnterFrame:function(){this.disableControls||(void 0!==this._speed.x&&null!==this._speed.x&&(this.vx=this._speed.x*this._direction.x),void 0!==this._speed.y&&null!==this._speed.y&&(this.vy=this._speed.y*this._direction.y))}},_updateDirection:function(t){this._direction.x=t.x,this._direction.y=t.y},multiway:function(t,e,i){var r=n.s("Controls");return e?this.speed(t):e=t,r.defineDpad(this._dpadName,e,i),this.linkInput("DirectionalInput",this._dpadName,this._updateDirection),this},speed:function(t){return"object"===(void 0===t?"undefined":o(t))?(this._speed.x=t.x,this._speed.y=t.y):(this._speed.x=t,this._speed.y=t),this}}),n.c("Jumper",{_jumpSpeed:300,canJump:!0,init:function(){this.requires("Supportable, Motion, Controllable")},remove:function(){this.unlinkInput("TriggerInputDown",this._jumpTriggerName)},_keydown_jumper:function(t){this.disableControls||this.jump()},jump:function(){var t=this.ground;return this.canJump=!!t,this.trigger("CheckJumping",t),this.canJump&&(this.vy=-this._jumpSpeed),this},jumper:function(t,e){if(e?this._jumpSpeed=t:e=t,this._jumpTriggerName="JumpTrigger"+this[0],Array.isArray(e)){for(var i=[],r=0;r<e.length;++r){var s=e[r],o=n.keys[s]||s;i.push(o)}n.s("Controls").defineTriggerGroup(this._jumpTriggerName,{keys:i})}else n.s("Controls").defineTriggerGroup(this._jumpTriggerName,e);return this.linkInput("TriggerInputDown",this._jumpTriggerName,this._keydown_jumper),this},jumpSpeed:function(t){return this._jumpSpeed=t,this}}),n.c("Fourway",{init:function(){this.requires("Multiway")},fourway:function(t){return this.multiway(t||this._speed,{UP_ARROW:-90,DOWN_ARROW:90,RIGHT_ARROW:0,LEFT_ARROW:180,W:-90,S:90,D:0,A:180,Z:-90,Q:180}),this}}),n.c("Twoway",{init:function(){this.requires("Multiway, Jumper")},twoway:function(t,e){var i=t||this._speed;return this.multiway({x:i},{RIGHT_ARROW:0,LEFT_ARROW:180,D:0,A:180,Q:180}),this.jumper(e||2*t||this._jumpSpeed,[n.keys.UP_ARROW,n.keys.W,n.keys.Z]),this}})},{"../core/core.js":9}],5:[function(t,e,i){var n=t("../core/core.js");n.extend({device:{_deviceOrientationCallback:!1,_deviceMotionCallback:!1,_normalizeDeviceOrientation:function(t){var e;window.DeviceOrientationEvent?e={tiltLR:t.gamma,tiltFB:t.beta,dir:t.alpha,motUD:null}:window.OrientationEvent&&(e={tiltLR:90*t.x,tiltFB:-90*t.y,dir:null,motUD:t.z}),n.device._deviceOrientationCallback(e)},_normalizeDeviceMotion:function(t){var e=t.accelerationIncludingGravity,i=e.z>0?1:-1,r={acceleration:e,rawAcceleration:"["+Math.round(e.x)+", "+Math.round(e.y)+", "+Math.round(e.z)+"]",facingUp:i,tiltLR:Math.round(e.x/9.81*-90),tiltFB:Math.round((e.y+9.81)/9.81*90*i)};n.device._deviceMotionCallback(r)},deviceOrientation:function(t){this._deviceOrientationCallback=t,n.support.deviceorientation&&(window.DeviceOrientationEvent?n.addEvent(this,window,"deviceorientation",this._normalizeDeviceOrientation):window.OrientationEvent&&n.addEvent(this,window,"MozOrientation",this._normalizeDeviceOrientation))},deviceMotion:function(t){this._deviceMotionCallback=t,n.support.devicemotion&&window.DeviceMotionEvent&&n.addEvent(this,window,"devicemotion",this._normalizeDeviceMotion)}}})},{"../core/core.js":9}],6:[function(t,e,i){var n=t("../core/core.js"),r=window.document;n.extend({over:null,mouseObjs:0,mousePos:{},touchObjs:0,lastEvent:null,keydown:{},selected:!1,detectBlur:function(t){var e=t.clientX>n.stage.x&&t.clientX<n.stage.x+n.viewport.width&&t.clientY>n.stage.y&&t.clientY<n.stage.y+n.viewport.height;!n.selected&&e&&n.trigger("CraftyFocus"),n.selected&&!e&&n.trigger("CraftyBlur"),n.selected=e},multitouch:function(t){if("boolean"!=typeof t)return this._touchHandler.multitouch;this._touchHandler.multitouch=t},resetKeyDown:function(){for(var t in n.keys)n.keydown[n.keys[t]]&&this.trigger("KeyUp",{key:n.keys[t]});n.keydown={}},mouseButtonsDown:{},mouseDispatch:function(t){if(n.mouseObjs){n.lastEvent=t;var e,i=t.target?t.target:t.srcElement,r=n.domHelper.translate(t.clientX,t.clientY),s=t.type;void 0===t.which?t.mouseButton=t.button<2?n.mouseButtons.LEFT:4===t.button?n.mouseButtons.MIDDLE:n.mouseButtons.RIGHT:t.mouseButton=t.which<2?n.mouseButtons.LEFT:2===t.which?n.mouseButtons.MIDDLE:n.mouseButtons.RIGHT,n.mousePos.x=r.x,n.mousePos.y=r.y,"mousedown"===s&&(this.mouseButtonsDown[t.mouseButton]=!0),"mouseup"===s&&delete this.mouseButtonsDown[t.mouseButton],e=n.findPointerEventTargetByComponent("Mouse",t,i),e?"mousedown"===s?e.trigger("MouseDown",t):"mouseup"===s?e.trigger("MouseUp",t):"dblclick"===s?e.trigger("DoubleClick",t):"click"===s?e.trigger("Click",t):"mousemove"===s?(e.trigger("MouseMove",t),this.over!==e&&(this.over&&(this.over.trigger("MouseOut",t),this.over=null),this.over=e,e.trigger("MouseOver",t))):e.trigger(s,t):("mousemove"===s&&this.over&&(this.over.trigger("MouseOut",t),this.over=null),"mousedown"===s?n.viewport.mouselook("start",t):"mousemove"===s?n.viewport.mouselook("drag",t):"mouseup"===s&&n.viewport.mouselook("stop"),"mousedown"===s?n.s("Controls").trigger("MouseDown",t):"mouseup"===s?n.s("Controls").trigger("MouseUp",t):"dblclick"===s?n.s("Controls").trigger("DoubleClick",t):"click"===s&&n.s("Controls").trigger("Click",t)),"mousemove"===s&&(this.lastEvent=t)}},touchDispatch:function(t){if(n.touchObjs||n.mouseObjs){if(this._touchHandler.multitouch)switch(t.type){case"touchstart":this._touchHandler.handleStart(t);break;case"touchmove":this._touchHandler.handleMove(t);break;case"touchleave":case"touchcancel":case"touchend":this._touchHandler.handleEnd(t)}else this._touchHandler.mimicMouse(t);t.target&&"INPUT"!==t.target.nodeName&&"TEXTAREA"!==t.target.nodeName&&(t.preventDefault?t.preventDefault():t.returnValue=!1)}},_touchHandler:{fingers:[],multitouch:!1,handleStart:function(t){for(var e=t.changedTouches,i=0,n=e.length;i<n;i++){var r,s=!1,o=t.target?t.target:t.srcElement;r=this.findClosestTouchEntity(e[i],o),r&&(r.trigger("TouchStart",e[i]),s=this.fingerDownIndexByEntity(r));var a=this.setTouch(e[i],r);!1!==s&&s>=0?this.fingers[s]=a:this.fingers.push(a)}},handleMove:function(t){for(var e=t.changedTouches,i=0,n=e.length;i<n;i++){var r=this.fingerDownIndexById(e[i].identifier),s=t.target?t.target:t.srcElement,a=this.findClosestTouchEntity(e[i],s);if(r>=0){var h=this.fingers[r];void 0!==h.entity&&(h.entity===a?h.entity.trigger("TouchMove",e[i]):("object"===(void 0===a?"undefined":o(a))&&a.trigger("TouchStart",e[i]),h.entity.trigger("TouchEnd"))),h.entity=a,h.realX=e[i].realX,h.realY=e[i].realY}}},handleEnd:function(t){for(var e=t.changedTouches,i="touchcancel"===t.type?"TouchCancel":"TouchEnd",n=0,r=e.length;n<r;n++){var s=this.fingerDownIndexById(e[n].identifier);s>=0&&(this.fingers[s].entity&&this.fingers[s].entity.trigger(i),this.fingers.splice(s,1))}},setTouch:function(t,e){return{identifier:t.identifier,realX:t.realX,realY:t.realY,entity:e}},findClosestTouchEntity:function(t,e){return n.findPointerEventTargetByComponent("Touch",t,e)},fingerDownIndexById:function(t){for(var e=0,i=this.fingers.length;e<i;e++){if(this.fingers[e].identifier===t)return e}return-1},fingerDownIndexByEntity:function(t){for(var e=0,i=this.fingers.length;e<i;e++){if(this.fingers[e].entity===t)return e}return-1},mimicMouse:function(t){var e,i,s=n.lastEvent;"touchstart"===t.type?e="mousedown":"touchmove"===t.type?e="mousemove":"touchend"===t.type?e="mouseup":"touchcancel"===t.type?e="mouseup":"touchleave"===t.type&&(e="mouseup"),t.touches&&t.touches.length?i=t.touches[0]:t.changedTouches&&t.changedTouches.length&&(i=t.changedTouches[0]);var o=r.createEvent("MouseEvent");o.initMouseEvent(e,!0,!0,window,1,i.screenX,i.screenY,i.clientX,i.clientY,!1,!1,!1,!1,0,t.relatedTarget),i.target.dispatchEvent(o),null!==s&&"mousedown"===s.type&&"mouseup"===e&&(e="click",o=r.createEvent("MouseEvent"),o.initMouseEvent(e,!0,!0,window,1,i.screenX,i.screenY,i.clientX,i.clientY,!1,!1,!1,!1,0,t.relatedTarget),i.target.dispatchEvent(o))}},findPointerEventTargetByComponent:function(t,e,i){var r,s,o,a,h,u,c,l=i||n.stage.elem,d=-1/0,_=e.clientX,p=e.clientY;if("CANVAS"!==l.nodeName){for(;"string"!=typeof l.id&&-1===l.id.indexOf("ent");)l=l.parentNode;var f=n(parseInt(l.id.replace("ent",""),10));u=n.domHelper.translate(_,p,f._drawLayer),f.__c[t]&&f.isAt(u.x,u.y)&&(r=f,c=u)}if(!r)for(var g in n._drawLayers){var m=n._drawLayers[g];if(!(m._pointerEntities<=0))for(u=n.domHelper.translate(_,p,m),o=n.map.search({_x:u.x,_y:u.y,_w:1,_h:1},!1),h=0,a=o.length;h<a;++h)s=o[h],s._visible&&s._drawLayer===m&&s._globalZ>d&&s.__c[t]&&s.isAt(u.x,u.y)&&(d=s._globalZ,r=s,c=u)}return c||(c=n.domHelper.translate(_,p)),e.realX=c.x,e.realY=c.y,r},mouseWheelDispatch:function(t){t.direction=t.detail<0||t.wheelDelta>0?1:-1,n.trigger("MouseWheelScroll",t)},keyboardDispatch:function(t){for(var e=t,i={},r="char charCode keyCode type shiftKey ctrlKey metaKey timestamp".split(" "),s=r.length;s;){var o=r[--s];i[o]=e[o]}if(i.which=null!==e.charCode?e.charCode:e.keyCode,i.key=e.keyCode||e.which,i.originalEvent=e,t=i,"keydown"===t.type?!0!==n.keydown[t.key]&&(n.keydown[t.key]=!0,n.trigger("KeyDown",t)):"keyup"===t.type&&(delete n.keydown[t.key],n.trigger("KeyUp",t)),n.selected&&!(8===t.key||t.key>=112&&t.key<=135))return e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,e.target&&"INPUT"!==e.target.nodeName&&"TEXTAREA"!==e.target.nodeName&&(e.preventDefault?e.preventDefault():e.returnValue=!1),!1}}),n._preBind("Load",function(){n.addEvent(this,"keydown",n.keyboardDispatch),n.addEvent(this,"keyup",n.keyboardDispatch),n.addEvent(this,n.stage.elem,"mousedown",n.mouseDispatch),n.addEvent(this,n.stage.elem,"mouseup",n.mouseDispatch),n.addEvent(this,r.body,"mouseup",n.detectBlur),n.addEvent(this,window,"blur",n.resetKeyDown),n.addEvent(this,n.stage.elem,"mousemove",n.mouseDispatch),n.addEvent(this,n.stage.elem,"click",n.mouseDispatch),n.addEvent(this,n.stage.elem,"dblclick",n.mouseDispatch),n.addEvent(this,n.stage.elem,"touchstart",n.touchDispatch),n.addEvent(this,n.stage.elem,"touchmove",n.touchDispatch),n.addEvent(this,n.stage.elem,"touchend",n.touchDispatch),n.addEvent(this,n.stage.elem,"touchcancel",n.touchDispatch),n.addEvent(this,n.stage.elem,"touchleave",n.touchDispatch),"Moz"===n.support.prefix?n.addEvent(this,n.stage.elem,"DOMMouseScroll",n.mouseWheelDispatch):n.addEvent(this,n.stage.elem,"mousewheel",n.mouseWheelDispatch)}),n._preBind("CraftyStop",function(){n.removeEvent(this,"keydown",n.keyboardDispatch),n.removeEvent(this,"keyup",n.keyboardDispatch),n.stage&&(n.removeEvent(this,n.stage.elem,"mousedown",n.mouseDispatch),n.removeEvent(this,n.stage.elem,"mouseup",n.mouseDispatch),n.removeEvent(this,n.stage.elem,"mousemove",n.mouseDispatch),n.removeEvent(this,n.stage.elem,"click",n.mouseDispatch),n.removeEvent(this,n.stage.elem,"dblclick",n.mouseDispatch),n.removeEvent(this,n.stage.elem,"touchstart",n.touchDispatch),n.removeEvent(this,n.stage.elem,"touchmove",n.touchDispatch),n.removeEvent(this,n.stage.elem,"touchend",n.touchDispatch),n.removeEvent(this,n.stage.elem,"touchcancel",n.touchDispatch),n.removeEvent(this,n.stage.elem,"touchleave",n.touchDispatch),"Moz"===n.support.prefix?n.removeEvent(this,n.stage.elem,"DOMMouseScroll",n.mouseWheelDispatch):n.removeEvent(this,n.stage.elem,"mousewheel",n.mouseWheelDispatch)),n.removeEvent(this,r.body,"mouseup",n.detectBlur),n.removeEvent(this,window,"blur",n.resetKeyDown)}),n.c("Mouse",{init:function(){n.mouseObjs++,this.requires("AreaMap").bind("Remove",function(){n.mouseObjs--})}}),n.c("Touch",{init:function(){n.touchObjs++,this.requires("AreaMap").bind("Remove",function(){n.touchObjs--})}}),n.c("AreaMap",{init:function(){this.has("Renderable")&&this._drawLayer&&this._drawLayer._pointerEntities++},remove:function(){this.has("Renderable")&&this._drawLayer&&this._drawLayer._pointerEntities--},events:{LayerAttached:function(t){t._pointerEntities++},LayerDetached:function(t){t._pointerEntities--}},areaMap:function(t){if(arguments.length>1){var e=Array.prototype.slice.call(arguments,0);t=new n.polygon(e)}else t=t.constructor===Array?new n.polygon(t.slice()):t.clone();return t.shift(this._x,this._y),this.mapArea=t,this.attach(this.mapArea),this.trigger("NewAreaMap",t),this}}),n.c("Button",{init:function(){var t=!n.mobile||n.mobile&&!n.multitouch()?"Mouse":"Touch";this.requires(t)}}),n.c("MouseDrag",{_dragging:!1,init:function(){this.requires("Mouse"),this.bind("MouseDown",this._ondown)},remove:function(){this.unbind("MouseDown",this._ondown)},_ondown:function(t){t.mouseButton===n.mouseButtons.LEFT&&this.startDrag(t)},_ondrag:function(t){if(!this._dragging||0===t.realX||0===t.realY)return!1;this.trigger("Dragging",t)},_onup:function(t){t.mouseButton===n.mouseButtons.LEFT&&this.stopDrag(t)},startDrag:function(t){if(!this._dragging)return this._dragging=!0,n.addEvent(this,n.stage.elem,"mousemove",this._ondrag),n.addEvent(this,n.stage.elem,"mouseup",this._onup),this.trigger("StartDrag",t||n.lastEvent),this},stopDrag:function(t){if(this._dragging)return this._dragging=!1,n.removeEvent(this,n.stage.elem,"mousemove",this._ondrag),n.removeEvent(this,n.stage.elem,"mouseup",this._onup),this.trigger("StopDrag",t||n.lastEvent),this}}),n.c("Keyboard",{isDown:function(t){return"string"==typeof t&&(t=n.keys[t]),!!n.keydown[t]}})},{"../core/core.js":9}],7:[function(t,e,i){t("../core/core.js").extend({keys:{BACKSPACE:8,TAB:9,ENTER:13,PAUSE:19,CAPS:20,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBSTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,SHIFT:16,CTRL:17,ALT:18,PLUS:187,COMMA:188,MINUS:189,PERIOD:190,PULT_UP:29460,PULT_DOWN:29461,PULT_LEFT:4,PULT_RIGHT:5},mouseButtons:{LEFT:0,MIDDLE:1,RIGHT:2}})},{"../core/core.js":9}],8:[function(t,e,i){var n=t("../core/core.js"),r=function(t,e){this.timePerFrame=1e3/n.timer.FPS(),this.duration=t,"function"==typeof e?this.easing_function=e:"string"==typeof e&&this.standardEasingFunctions[e]?this.easing_function=this.standardEasingFunctions[e]:this.easing_function=this.standardEasingFunctions.linear,this.reset()};r.prototype={duration:0,clock:0,steps:null,complete:!1,paused:!1,reset:function(){this.loops=1,this.clock=0,this.complete=!1,this.paused=!1},repeat:function(t){this.loops=t},setProgress:function(t,e){this.clock=this.duration*t,void 0!==e&&(this.loops=e)},pause:function(){this.paused=!0},resume:function(){this.paused=!1,this.complete=!1},tick:function(t){if(!this.paused&&!this.complete)for(this.clock+=t,this.frames=Math.floor(this.clock/this.timePerFrame);this.clock>=this.duration&&!1===this.complete;)this.loops--,this.loops>0?this.clock-=this.duration:this.complete=!0},time:function(){return Math.min(this.clock/this.duration,1)},value:function(){return this.easing_function(this.time())},standardEasingFunctions:{linear:function(t){return t},smoothStep:function(t){return(3-2*t)*t*t},smootherStep:function(t){return(6*t*t-15*t+10)*t*t*t},easeInQuad:function(t){return t*t},easeOutQuad:function(t){return t*(2-t)},easeInOutQuad:function(t){return t<.5?2*t*t:(4-2*t)*t-1}}},e.exports=r},{"../core/core.js":9}],9:[function(t,e,i){function n(){var t=h++;return t in l?n():t}function a(t){if(null===t||"object"!==(void 0===t?"undefined":o(t)))return t;var e=t.constructor();for(var i in t)e[i]=a(t[i]);return e}var h,u,c,l,d,_,p,f,g,m=t("./version"),v=function t(e){return new t.fn.init(e)};c={},p=Array.prototype.slice,f=/\s*,\s*/,g=/\s+/;var y=function(){h=1,u=0,l={},d={},_=[]};y(),v.fn=v.prototype={init:function(t){if("string"!=typeof t)return t||(t=0)in l||(l[t]=this),t in l?(this[0]=t,this.length=1,this.__c||(this.__c={}),this._callbacks||v._addCallbackMethods(this),l[t]||(l[t]=this),l[t]):(this.length=0,this);var e,i,n,r,s,o,a,h=0,u=!1,d=!1;if("*"===t){o=0;for(e in l)this[o]=+e,o++;return this.length=o,1===o?l[this[0]]:this}-1!==t.indexOf(",")?(d=!0,n=f):-1!==t.indexOf(" ")&&(u=!0,n=g);for(e in l)if(l.hasOwnProperty(e))if(i=l[e],u||d){for(r=t.split(n),o=0,a=r.length,s=0;o<a;o++)i.__c[r[o]]&&s++;(u&&s===a||d&&s>0)&&(this[h++]=+e)}else i.__c[t]&&(this[h++]=+e);if(h>0&&!u&&!d&&this.extend(c[t]),r&&u)for(o=0;o<a;o++)this.extend(c[r[o]]);return this.length=h,1===h?l[this[h-1]]:(v._addCallbackMethods(this),this)},setName:function(t){var e=String(t);return this._entityName=e,this.trigger("NewEntityName",e),this},getName:function(t){return this._entityName},addComponent:function(t){var e,i,n=0;for(e=1===arguments.length&&-1!==t.indexOf(",")?t.split(f):arguments;n<e.length;n++)if(!0!==this.__c[e[n]]&&(this.__c[e[n]]=!0,i=c[e[n]],this.extend(i),i&&"required"in i&&this.requires(i.required),i&&"init"in i&&i.init.call(this),i&&"events"in i)){var r=i.events;for(var s in r){var o="function"==typeof r[s]?r[s]:i[r[s]];this.bind(s,o)}}return this.trigger("NewComponent",e),this},toggleComponent:function(t){var e,i,n=0;if(arguments.length>1)for(e=arguments.length;n<e;n++)this.has(arguments[n])?this.removeComponent(arguments[n]):this.addComponent(arguments[n]);else if(-1!==t.indexOf(","))for(i=t.split(f),e=i.length;n<e;n++)this.has(i[n])?this.removeComponent(i[n]):this.addComponent(i[n]);else this.has(t)?this.removeComponent(t):this.addComponent(t);return this},requires:function(t){return this.addComponent(t)},removeComponent:function(t,e){var i=c[t];if(this.trigger("RemoveComponent",t),i&&"events"in i){var n=i.events;for(var r in n){var s="function"==typeof n[r]?n[r]:i[n[r]];this.unbind(r,s)}}if(i&&"remove"in i&&i.remove.call(this,!1),!1===e&&i)for(var o in i)delete this[o];return delete this.__c[t],this},getId:function(){return this[0]},has:function(t){return!!this.__c[t]},attr:function(t,e,i,n){return 1===arguments.length&&"string"==typeof arguments[0]?this._attr_get(t):this._attr_set(t,e,i,n)},_attr_get:function(t,e){var i,n;return void 0!==e&&null!==e||(e=this),t.indexOf(".")>-1?(n=t.split("."),i=n.shift(),n.join("."),this._attr_get(n.join("."),e[i])):e[t]},_attr_set:function(){var t,e,i;return"string"==typeof arguments[0]?(t=this._set_create_object(arguments[0],arguments[1]),e=!!arguments[2],i=arguments[3]||arguments[0].indexOf(".")>-1):(t=arguments[0],e=!!arguments[1],i=!!arguments[2]),e||this.trigger("Change",t),i?this._recursive_extend(t,this):this.extend.call(this,t),this},_set_create_object:function(t,e){var i,n,r,s={};return t.indexOf(".")>-1?(i=t.split("."),n=i.shift(),r=i.join("."),s[n]=this._set_create_object(r,e)):s[t]=e,s},_recursive_extend:function(t,e){var i;for(i in t)t[i].constructor===Object?e[i]=this._recursive_extend(t[i],e[i]):e[i]=t[i];return e},toArray:function(){return p.call(this,0)},timeout:function(t,e){return this.each(function(){var i=this;setTimeout(function(){t.call(i)},e)}),this},bind:function(t,e){if(1===this.length)this._bindCallback(t,e);else for(var i=0;i<this.length;i++){var n=l[this[i]];n&&n._bindCallback(t,e)}return this},uniqueBind:function(t,e){this.unbind(t,e),this.bind(t,e)},one:function(t,e){var i=this,n=function n(r){e.call(i,r),i.unbind(t,n)};return i.bind(t,n)},unbind:function(t,e){var i,n;for(i=0;i<this.length;i++)(n=l[this[i]])&&n._unbindCallbacks(t,e);return this},trigger:function(t,e){if(1===this.length)this._runCallbacks(t,e);else for(var i=0;i<this.length;i++){var n=l[this[i]];n&&n._runCallbacks(t,e)}return this},each:function(t){for(var e=0,i=this.length;e<i;e++)l[this[e]]&&t.call(l[this[e]],e);return this},get:function(t){var e=this.length;if(void 0!==t){if(t>=e||t+e<0)return;return t>=0?l[this[t]]:l[this[t+e]]}for(var i=0,n=[];i<e;i++)l[this[i]]&&n.push(l[this[i]]);return n},clone:function(){var t,e,i=this.__c,n=v.e();for(t in i)n.addComponent(t);for(e in this)"0"!==e&&"_global"!==e&&"_changed"!==e&&"function"!=typeof this[e]&&"object"!==o(this[e])&&(n[e]=this[e]);return n},setter:function(t,e){return this.defineField(t,function(){},e)},defineField:function(t,e,i){return v.defineField(this,t,e,i),this},destroy:function(){this.each(function(){var t;this.trigger("Remove");for(var e in this.__c)(t=c[e])&&"remove"in t&&t.remove.call(this,!0);this._unbindAll(),delete l[this[0]]})}},v.fn.init.prototype=v.fn,v.extend=v.fn.extend=function(t){var e,i=this;if(!t)return i;for(e in t)i!==t[e]&&(i[e]=t[e]);return i},v._callbackMethods={_bindCallback:function(t,e){var i=this._callbacks[t];i||(i=this._callbacks[t]=(d[t]||(d[t]={}))[this[0]]=[],i.context=this,i.depth=0),i.push(e)},_runCallbacks:function(t,e){if(this._callbacks[t]){var i,n=this._callbacks[t],r=n.length;for(n.depth++,i=0;i<r;i++)void 0===n[i]?n.depth<=1&&(n.splice(i,1),i--,r--,0===n.length&&(delete this._callbacks[t],delete d[t][this[0]])):n[i].call(this,e);n.depth--}},_unbindCallbacks:function(t,e){if(this._callbacks[t])for(var i=this._callbacks[t],n=0;n<i.length;n++)e&&i[n]!==e||delete i[n]},_unbindAll:function(){if(this._callbacks)for(var t in this._callbacks)this._callbacks[t]&&(this._unbindCallbacks(t),delete d[t][this[0]])}},v._addCallbackMethods=function(t){t.extend(v._callbackMethods),t._callbacks={}},v._addCallbackMethods(v),v.extend({0:"global",init:function(t,e,i){if(!this._preBindDone)for(var n=0;n<this._bindOnInit.length;n++){var r=this._bindOnInit[n];v.bind(r.event,r.handler)}return v.viewport.init(t,e,i),this.trigger("Load"),this.timer.init(),this},_bindOnInit:[],_preBindDone:!1,_preBind:function(t,e){this._bindOnInit.push({event:t,handler:e})},getVersion:function(){return m},stop:function(t){if(v.trigger("CraftyStop",t),this.timer.stop(),t){v.audio.remove();for(var e in v._systems)v._systems[e].destroy();if(v.stage&&v.stage.elem.parentNode){var i=document.createElement("div");i.id=v.stage.elem.id,v.stage.elem.parentNode.replaceChild(i,v.stage.elem)}v._unbindAll(),v._addCallbackMethods(v),this._preBindDone=!1,y()}return this},pause:function(t){return(1===arguments.length?t:!this._paused)?(this.trigger("Pause"),this._paused=!0,setTimeout(function(){v.timer.stop()},0),v.keydown={}):(this.trigger("Unpause"),this._paused=!1,setTimeout(function(){v.timer.init()},0)),this},isPaused:function(){return this._paused},timer:function(){var t,e,i,n="fixed",r=5,s=40,o=0,a=0,h=50,c=1e3/h;return{init:function(){void 0===i&&(i=(new Date).getTime()-c);var n="undefined"!=typeof window&&(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||null);n?(t=function(){v.timer.step(),null!==t&&(e=n(t))})():t=setInterval(function(){v.timer.step()},1e3/h)},stop:function(){v.trigger("CraftyStopTimer"),"function"!=typeof t&&clearInterval(t);var i="undefined"!=typeof window&&(window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||null);i&&i(e),t=null},steptype:function(t,e){if("variable"===t||"semifixed"===t)n=t,e&&(s=e),v.trigger("NewSteptype",{mode:n,maxTimeStep:s});else{if("fixed"!==t){if(void 0!==t)throw"Invalid step type specified";return{mode:n,maxTimeStep:"variable"===n||"semifixed"===n?s:r}}n="fixed",e&&(r=e),v.trigger("NewSteptype",{mode:n,maxTimeStep:r})}},step:function(){var t,e,h,l=0,d=(new Date).getTime();if(o>0&&v.trigger("MeasureWaitTime",d-o),i+a>=d)return void(o=d);var _=d-(i+a);_>20*c&&(a+=_-c,_=c),"fixed"===n?(l=Math.ceil(_/c),l=Math.min(l,r),e=c):"variable"===n?(l=1,e=_,e=Math.min(e,s)):"semifixed"===n&&(l=Math.ceil(_/s),e=_/l);for(var p=0;p<l;p++){h=d;var f={frame:u++,dt:e,gameTime:i};v.trigger("EnterFrameInput",f),v.trigger("EnterFrame",f),v.trigger("ExitFrame",f),i+=e,d=(new Date).getTime(),v.trigger("MeasureFrameTime",d-h)}l>0&&(t=d,v.trigger("PreRender"),v.trigger("RenderScene"),v.trigger("PostRender"),d=(new Date).getTime(),v.trigger("MeasureRenderTime",d-t)),o=d},FPS:function(t){if(void 0===t)return h;h=t,c=1e3/h,v.trigger("FPSChange",t)},simulateFrames:function(t,e){for(e=e||c;t-- >0;){var i={frame:u++,dt:e};v.trigger("EnterFrameInput",i),v.trigger("EnterFrame",i),v.trigger("ExitFrame",i)}v.trigger("PreRender"),v.trigger("RenderScene"),v.trigger("PostRender")}}}(),e:function(){var t=n();return l[t]=null,l[t]=v(t),arguments.length>0&&l[t].addComponent.apply(l[t],arguments),l[t].setName("Entity #"+t),l[t].addComponent("obj"),v.trigger("NewEntity",{id:t}),l[t]},c:function(t,e){c[t]=e},trigger:function(t,e){var i,n,r=d[t]||(d[t]={});for(i in r)r.hasOwnProperty(i)&&(n=r[i])&&0!==n.length&&n.context._runCallbacks(t,e)},bind:function(t,e){return this._bindCallback(t,e),e},uniqueBind:function(t,e){return this.unbind(t,e),this.bind(t,e)},one:function(t,e){var i=this,n=function n(r){e.call(i,r),i.unbind(t,n)};return i.bind(t,n)},unbind:function(t,e){this._unbindCallbacks(t,e)},frame:function(){return u},components:function(){return c},isComp:function(t){return t in c},debug:function(t){return"handlers"===t?d:l},settings:function(){var t={},e={};return{register:function(t,i){e[t]=i},modify:function(i,n){e[i]&&(e[i].call(t[i],n),t[i]=n)},get:function(e){return t[e]}}}(),defineField:function(t,e,i,n){Object.defineProperty(t,e,{get:i,set:n,configurable:!1,enumerable:!0})},clone:a}),r=[],void 0!==(s=function(){return v}.apply(i,r))&&(e.exports=s),e.exports=v},{"./version":18}],10:[function(t,e,i){(function(i){var n=t("../core/core.js"),r="undefined"!=typeof window&&window.document;!function(){var t=n.support={},e="undefined"!=typeof navigator&&navigator.userAgent.toLowerCase()||void 0!==i&&i.version,s=/(webkit)[ \/]([\w.]+)/.exec(e)||/(o)pera(?:.*version)?[ \/]([\w.]+)/.exec(e)||/(ms)ie ([\w.]+)/.exec(e)||/(moz)illa(?:.*? rv:([\w.]+))?/.exec(e)||/(v)\d+\.(\d+)/.exec(e)||[],o=/iPad|iPod|iPhone|Android|webOS|IEMobile/i.exec(e);if(o&&(n.mobile=o[0]),t.defineProperty=function(){if(!("defineProperty"in Object))return!1;try{Object.defineProperty({},"x",{})}catch(t){return!1}return!0}(),t.audio="undefined"!=typeof window&&"canPlayType"in r.createElement("audio"),t.prefix=s[1]||s[0],"moz"===t.prefix&&(t.prefix="Moz"),"o"===t.prefix&&(t.prefix="O"),"v"===t.prefix&&(t.prefix="node"),s[2]&&(t.versionName=s[2],t.version=+s[2].split(".")[0]),t.canvas="undefined"!=typeof window&&"getContext"in r.createElement("canvas"),t.canvas){var a;try{var h=r.createElement("canvas");a=h.getContext("webgl")||h.getContext("experimental-webgl"),a.viewportWidth=t.canvas.width,a.viewportHeight=t.canvas.height}catch(t){}t.webgl=!!a}else t.webgl=!1;t.css3dtransform="undefined"!=typeof window&&(void 0!==r.createElement("div").style.Perspective||void 0!==r.createElement("div").style[t.prefix+"Perspective"]),t.deviceorientation="undefined"!=typeof window&&(void 0!==window.DeviceOrientationEvent||void 0!==window.OrientationEvent),t.devicemotion="undefined"!=typeof window&&void 0!==window.DeviceMotionEvent}(),e.exports={_events:{},addEvent:function(t,e,i,n){3===arguments.length&&(n=i,i=e,e=window.document);var r=function(e){n.call(t,e)},s=t[0]||"";this._events[s+e+i+n]||(this._events[s+e+i+n]=r,e.addEventListener(i,r,!1))},removeEvent:function(t,e,i,n){3===arguments.length&&(n=i,i=e,e=window.document);var r=t[0]||"",s=this._events[r+e+i+n];s&&(e.removeEventListener(i,s,!1),delete this._events[r+e+i+n])},background:function(t){n.stage.elem.style.background=t}}}).call(this,t("_process"))},{"../core/core.js":9,_process:1}],11:[function(t,e,i){var n=t("../core/core.js");e.exports={assets:{},__paths:{audio:"",images:""},paths:function(t){if(void 0===t)return this.__paths;t.audio&&(this.__paths.audio=t.audio),t.images&&(this.__paths.images=t.images)},asset:function(t,e){return 1===arguments.length?n.assets[t]:n.assets[t]?void 0:(n.assets[t]=e,this.trigger("NewAsset",{key:t,value:e}),e)},imageWhitelist:["jpg","jpeg","gif","png","svg"],load:function(t,e,i,r){function s(){var t=this.src;this.removeEventListener&&this.removeEventListener("canplaythrough",s,!1),_++,i&&i({loaded:_,total:p,percent:_/p*100,src:t}),_===p&&e&&e()}function a(){var t=this.src;r&&r({loaded:_,total:p,percent:_/p*100,src:t}),++_===p&&e&&e()}if(Array.isArray(t))return void n.log("Calling Crafty.load with an array of assets no longer works; see the docs for more details.");t="string"==typeof t?JSON.parse(t):t;var h,u,c,l,d,_=0,p=(t.audio?Object.keys(t.audio).length:0)+(t.images?Object.keys(t.images).length:0)+(t.sprites?Object.keys(t.sprites).length:0),f=n.paths(),g=function(t){return t.substr(t.lastIndexOf(".")+1).toLowerCase()},m=function(t,e){return-1===e.search("://")?"audio"===t?f.audio+e:f.images+e:e},v=function(t){return n.asset(t)||null},y=function(t){return n.support.audio&&n.audio.supports(g(t))};for(l in t)for(d in t[l])if(t[l].hasOwnProperty(d)){if(h=t[l][d],c=null,"audio"===l){if("object"===(void 0===h?"undefined":o(h))){var w=[];for(var x in h)u=m(l,h[x]),v(u)||!y(h[x])||n.audio.sounds[d]||w.push(u);w.length>0&&(c=n.audio.add(d,w))}else"string"==typeof h&&(u=m(l,h),v(u)||!y(h)||n.audio.sounds[d]||(c=n.audio.add(d,u)));c&&(c=c.obj),c&&c.addEventListener&&c.addEventListener("canplaythrough",s,!1)}else d="sprites"===l?d:h,u=m(l,d),!v(u)&&function(t){return-1!==n.imageWhitelist.indexOf(g(t))}(d)&&(c=new Image,"sprites"===l&&n.sprite(h.tile,h.tileh,u,h.map,h.paddingX,h.paddingY,h.paddingAroundBorder),n.asset(u,c),function(t,e){t.onload=s,"webkit"===n.support.prefix&&(t.src=""),t.src=e}(c,u));c?c.onerror=a:a.call({src:u})}0===p&&e&&e()},removeAssets:function(t){t="string"==typeof t?JSON.parse(t):t;var e,i,r,s,a=n.paths(),h=function(t,e){return-1===e.search("://")?"audio"===t?a.audio+e:a.images+e:e};for(r in t)for(s in t[r])if(t[r].hasOwnProperty(s))if(e=t[r][s],"audio"===r)if("object"===(void 0===e?"undefined":o(e)))for(var u in e)i=h(r,e[u]),n.asset(i)&&n.audio.remove(s);else"string"==typeof e&&(i=h(r,e),n.asset(i)&&n.audio.remove(s));else if(s="sprites"===r?s:e,i=h(r,s),n.asset(i)){if("sprites"===r)for(var c in e.map)delete n.components()[c];delete n.assets[i]}}}},{"../core/core.js":9}],12:[function(t,e,i){var n=t("../core/core.js");e.exports={init:function(){this.changed=[],this.bind("Change",this._changed_attributes),this.bind("Change",this._changed_triggers)},_changed_triggers:function(t,e){var i;e=n.extend.call({pre:""},e);for(i in t)this.trigger("Change["+e.pre+i+"]",t[i]),t[i].constructor===Object&&this._changed_triggers(t[i],{pre:e.pre+i+"."})},_changed_attributes:function(t){var e;for(e in t)this.changed.push(e);return this},is_dirty:function(t){return 0===arguments.length?!!this.changed.length:this.changed.indexOf(t)>-1}}},{"../core/core.js":9}],13:[function(t,e,i){var n=t("../core/core.js");e.exports={_scenes:{},_current:null,scene:function(t,e,i){if(1===arguments.length||"function"!=typeof arguments[1])return void n.enterScene(t,arguments[1]);n.defineScene(t,e,i)},defineScene:function(t,e,i){if("function"!=typeof e)throw"Init function is the wrong type.";this._scenes[t]={},this._scenes[t].initialize=e,void 0!==i&&(this._scenes[t].uninitialize=i)},enterScene:function(t,e){if("function"==typeof e)throw"Scene data cannot be a function";n.trigger("SceneDestroy",{newScene:t}),n.viewport.reset(),n("2D").each(function(){this.has("Persist")||this.destroy()}),null!==this._current&&"uninitialize"in this._scenes[this._current]&&this._scenes[this._current].uninitialize.call(this);var i=this._current;this._current=t,n.trigger("SceneChange",{oldScene:i,newScene:t}),this._scenes.hasOwnProperty(t)?this._scenes[t].initialize.call(this,e):n.error('The scene "'+t+'" does not exist')}}},{"../core/core.js":9}],14:[function(t,e,i){var n=t("../core/core.js");try{var r="undefined"!=typeof window&&window.localStorage||new t("node-localstorage").LocalStorage("./localStorage")}catch(t){var r=null}var s=function(t,e){var i=e;if(!r)return n.error("Local storage is not accessible.  (Perhaps you are including crafty.js cross-domain?)"),!1;if(1===arguments.length)try{return JSON.parse(r.getItem(t))}catch(e){return r.getItem(t)}else"object"===(void 0===e?"undefined":o(e))&&(i=JSON.stringify(e)),r.setItem(t,i)};s.remove=function(t){if(!r)return void n.error("Local storage is not accessible.  (Perhaps you are including crafty.js cross-domain?)");r.removeItem(t)},e.exports=s},{"../core/core.js":9}],15:[function(t,e,i){function n(t,e){var i={};for(var n in e)i[n]=e[n];for(n in t)n in e||(i[n]=t[n]);return i}var r=t("../core/core.js");r._systems={},r.s=function(t,e,i,n){if(!e)return r._systems[t];"boolean"==typeof i&&(n=i,i=null),!1===n?(r._systems[t]=new r.CraftySystem(t,e,i),r.trigger("SystemLoaded",t)):r._registerLazySystem(t,e,i)},r._registerLazySystem=function(t,e,i){Object.defineProperty(r._systems,t,{get:function(){return Object.defineProperty(r._systems,t,{value:new r.CraftySystem(t,e,i),writable:!0,enumerable:!0,configurable:!0}),r.trigger("SystemLoaded",t),r._systems[t]},configurable:!0})},r.CraftySystem=function(){var t=1;return function(e,i,s){if(this.name=e,!i)return this;if(this._systemTemplate=i,this.extend(i),this.options=n(this.options,s),r._addCallbackMethods(this),this[0]="system"+t++,"function"==typeof this.init&&this.init(e),"events"in i){var o=i.events;for(var a in o){var h="function"==typeof o[a]?o[a]:i[o[a]];this.bind(a,h)}}}}(),r.CraftySystem.prototype={extend:function(t){for(var e in t)void 0===this[e]&&(this[e]=t[e])},bind:function(t,e){return this._bindCallback(t,e),this},trigger:function(t,e){return this._runCallbacks(t,e),this},unbind:function(t,e){return this._unbindCallbacks(t,e),this},one:function(t,e){var i=this,n=function n(r){e.call(i,r),i.unbind(t,n)};return i.bind(t,n)},uniqueBind:function(t,e){return this.unbind(t,e),this.bind(t,e)},destroy:function(){r.trigger("SystemDestroyed",this),"function"==typeof this.remove&&this.remove(),this._unbindAll(),delete r._systems[this.name]}}},{"../core/core.js":9}],16:[function(t,e,i){e.exports={init:function(){this._delays=[],this._delaysPaused=!1,this.bind("EnterFrame",function(t){if(!this._delaysPaused)for(var e=this._delays.length;--e>=0;){var i=this._delays[e];if(!1===i)this._delays.splice(e,1);else{for(i.accumulator+=t.dt;i.accumulator>=i.delay&&i.repeat>=0;)i.accumulator-=i.delay,i.repeat--,i.callback.call(this);i.repeat<0&&(this._delays.splice(e,1),"function"==typeof i.callbackOff&&i.callbackOff.call(this))}}})},delay:function(t,e,i,n){return this._delays.push({accumulator:0,callback:t,callbackOff:n,delay:e,repeat:(i<0?1/0:i)||0}),this},cancelDelay:function(t){for(var e=this._delays.length;--e>=0;){var i=this._delays[e];i&&i.callback===t&&(this._delays[e]=!1)}return this},pauseDelays:function(){this._delaysPaused=!0},resumeDelays:function(){this._delaysPaused=!1}}},{}],17:[function(t,e,i){var n=t("../core/core.js");e.exports={init:function(){this.tweenGroup={},this.tweenStart={},this.tweens=[],this.uniqueBind("EnterFrame",this._tweenTick)},_tweenTick:function(t){var e,i,n;for(n=this.tweens.length-1;n>=0;n--)e=this.tweens[n],e.easing.tick(t.dt),i=e.easing.value(),this._doTween(e.props,i),e.easing.complete&&(this.tweens.splice(n,1),this._endTween(e.props))},_doTween:function(t,e){for(var i in t)this[i]=(1-e)*this.tweenStart[i]+e*t[i]},tween:function(t,e,i){var r={props:t,easing:new n.easing(e,i)};for(var s in t)void 0!==this.tweenGroup[s]&&this.cancelTween(s),this.tweenStart[s]=this[s],this.tweenGroup[s]=t;return this.tweens.push(r),this},cancelTween:function(t){if("string"==typeof t)"object"===o(this.tweenGroup[t])&&delete this.tweenGroup[t][t];else if("object"===(void 0===t?"undefined":o(t)))for(var e in t)this.cancelTween(e);return this},pauseTweens:function(){this.tweens.map(function(t){t.easing.pause()})},resumeTweens:function(){this.tweens.map(function(t){t.easing.resume()})},_endTween:function(t){for(var e in t)delete this.tweenGroup[e];this.trigger("TweenEnd",t)}}},{"../core/core.js":9}],18:[function(t,e,i){e.exports="0.8.0"},{}],19:[function(t,e,i){var n=t("./core/core");n.easing=t("./core/animation"),n.extend(t("./core/extensions")),n.extend(t("./core/loader")),n.c("Model",t("./core/model")),n.extend(t("./core/scenes")),n.storage=t("./core/storage"),n.c("Delay",t("./core/time")),n.c("Tween",t("./core/tween")),t("./core/systems"),t("./spatial/2d"),t("./spatial/motion"),t("./spatial/platform"),t("./spatial/collision"),t("./spatial/spatial-grid"),t("./spatial/rect-manager"),t("./spatial/math"),t("./graphics/layers"),t("./graphics/canvas"),t("./graphics/canvas-layer"),t("./graphics/webgl"),t("./graphics/webgl-layer"),t("./graphics/color"),t("./graphics/dom"),t("./graphics/dom-helper"),t("./graphics/dom-layer"),t("./graphics/drawing"),t("./graphics/gl-textures"),t("./graphics/renderable"),t("./graphics/html"),t("./graphics/image"),t("./graphics/particles"),t("./graphics/sprite-animation"),t("./graphics/sprite"),t("./graphics/text"),t("./graphics/viewport"),t("./isometric/diamond-iso"),t("./isometric/isometric"),t("./controls/inputs"),t("./controls/controls-system"),t("./controls/controls"),t("./controls/device"),t("./controls/keycodes"),t("./sound/sound"),t("./debug/debug-layer"),t("./debug/logging"),t("./aliases").defineAliases(n),window&&(window.Crafty=n),e.exports=n},{"./aliases":2,"./controls/controls":4,"./controls/controls-system":3,"./controls/device":5,"./controls/inputs":6,"./controls/keycodes":7,"./core/animation":8,"./core/core":9,"./core/extensions":10,"./core/loader":11,"./core/model":12,"./core/scenes":13,"./core/storage":14,"./core/systems":15,"./core/time":16,"./core/tween":17,"./debug/debug-layer":20,"./debug/logging":21,"./graphics/canvas":23,"./graphics/canvas-layer":22,"./graphics/color":24,"./graphics/dom":27,"./graphics/dom-helper":25,"./graphics/dom-layer":26,"./graphics/drawing":28,"./graphics/gl-textures":29,"./graphics/html":30,"./graphics/image":31,"./graphics/layers":32,"./graphics/particles":33,"./graphics/renderable":34,"./graphics/sprite":36,"./graphics/sprite-animation":35,"./graphics/text":37,"./graphics/viewport":38,"./graphics/webgl":40,"./graphics/webgl-layer":39,"./isometric/diamond-iso":41,"./isometric/isometric":42,"./sound/sound":43,"./spatial/2d":44,"./spatial/collision":45,"./spatial/math":46,"./spatial/motion":47,"./spatial/platform":48,"./spatial/rect-manager":49,"./spatial/spatial-grid":50}],20:[function(t,e,i){var n=t("../core/core.js"),r=window.document;n.c("DebugCanvas",{init:function(){this.requires("2D"),n.DebugCanvas.context||n.DebugCanvas.init(),n.DebugCanvas.add(this),this._debug={alpha:1,lineWidth:1},this.bind("RemoveComponent",this.onDebugRemove),this.bind("Remove",this.onDebugDestroy)},onDebugRemove:function(t){"DebugCanvas"===t&&n.DebugCanvas.remove(this)},onDebugDestroy:function(t){n.DebugCanvas.remove(this)},debugAlpha:function(t){return this._debug.alpha=t,this},debugFill:function(t){return void 0===t&&(t="red"),this._debug.fillStyle=t,this},debugStroke:function(t){return void 0===t&&(t="red"),this._debug.strokeStyle=t,this},debugDraw:function(t){var e=t.globalAlpha,i=this._debug;i.alpha&&(t.globalAlpha=this._debug.alpha),i.strokeStyle&&(t.strokeStyle=i.strokeStyle),i.lineWidth&&(t.lineWidth=i.lineWidth),i.fillStyle&&(t.fillStyle=i.fillStyle),this.trigger("DebugDraw",t),t.globalAlpha=e}}),n.c("DebugRectangle",{init:function(){this.requires("2D, DebugCanvas")},debugRectangle:function(t){return this.debugRect=t,this.unbind("DebugDraw",this.drawDebugRect),this.bind("DebugDraw",this.drawDebugRect),this},drawDebugRect:function(t){var e=this.debugRect;null!==e&&void 0!==e&&e._h&&e._w&&(this._debug.fillStyle&&t.fillRect(e._x,e._y,e._w,e._h),this._debug.strokeStyle&&t.strokeRect(e._x,e._y,e._w,e._h))}}),n.c("VisibleMBR",{init:function(){this.requires("DebugRectangle").debugFill("purple").bind("EnterFrame",this._assignRect)},_assignRect:function(){this._mbr?this.debugRectangle(this._mbr):this.debugRectangle(this)}}),n.c("DebugPolygon",{init:function(){this.requires("2D, DebugCanvas")},debugPolygon:function(t){return this.polygon=t,this.unbind("DebugDraw",this.drawDebugPolygon),this.bind("DebugDraw",this.drawDebugPolygon),this},drawDebugPolygon:function(t){if(void 0!==this.polygon){t.beginPath();for(var e=this.polygon.points,i=e.length,n=0;n<i;n+=2)t.lineTo(e[n],e[n+1]);t.closePath(),this._debug.fillStyle&&t.fill(),this._debug.strokeStyle&&t.stroke()}}}),n.c("WiredHitBox",{init:function(){this.requires("DebugPolygon").debugStroke("red").matchHitBox(),this.bind("NewHitbox",this.matchHitBox)},matchHitBox:function(){this.debugPolygon(this.map)}}),n.c("SolidHitBox",{init:function(){this.requires("Collision, DebugPolygon").debugFill("orange").debugAlpha(.7).matchHitBox(),this.bind("NewHitbox",this.matchHitBox)},matchHitBox:function(){this.debugPolygon(this.map)}}),n.c("WiredAreaMap",{init:function(){this.requires("DebugPolygon").debugStroke("green").matchAreaMap(),this.bind("NewAreaMap",this.matchAreaMap)},matchAreaMap:function(){this.debugPolygon(this.mapArea)}}),n.c("SolidAreaMap",{init:function(){this.requires("DebugPolygon").debugFill("lime").debugAlpha(.7).matchAreaMap(),this.bind("NewAreaMap",this.matchAreaMap)},matchAreaMap:function(){this.debugPolygon(this.mapArea)}}),n.DebugCanvas={context:null,entities:[],onetimeEntities:[],add:function(t){this.entities.push(t)},remove:function(t){for(var e=this.entities,i=e.length-1;i>=0;i--)e[i]===t&&e.splice(i,1)},init:function(){if(!n.DebugCanvas.context){if(!n.support.canvas)return n.trigger("NoCanvas"),void n.stop();var t;t=r.createElement("canvas"),t.width=n.viewport.width,t.height=n.viewport.height,t.style.position="absolute",t.style.left="0px",t.style.top="0px",t.id="debug-canvas",t.style.zIndex=1e5,n.stage.elem.appendChild(t),n.DebugCanvas.context=t.getContext("2d"),n.DebugCanvas._canvas=t}n.unbind("RenderScene",n.DebugCanvas.renderScene),n.bind("RenderScene",n.DebugCanvas.renderScene)},renderScene:function(t){t=t||n.viewport.rect();var e,i=n.DebugCanvas.entities,r=0,s=i.length,o=n.DebugCanvas.context,a=n.viewport;o.setTransform(a._scale,0,0,a._scale,Math.round(a._x*a._scale),Math.round(a._y*a._scale)),o.clearRect(t._x,t._y,t._w,t._h);for(var h=null;r<s;r++)e=i[r],h!==e._drawlayer&&(a=e._drawLayer._viewportRect(),o.setTransform(a._scale,0,0,a._scale,Math.round(-a._x*a._scale),Math.round(-a._y*a._scale)),h=e._drawLayer),e.debugDraw(o)}}},{"../core/core.js":9}],21:[function(t,e,i){var n=t("../core/core.js");n.extend({loggingEnabled:!0,log:function(){n.loggingEnabled&&("undefined"!=typeof window?window.console:console)&&console.log&&console.log.apply(console,arguments)},error:function(){n.loggingEnabled&&("undefined"!=typeof window?window.console:console)&&console.error&&console.error.apply(console,arguments)}})},{"../core/core.js":9}],22:[function(t,e,i){var n=t("../core/core.js");n._registerLayerTemplate("Canvas",{type:"Canvas",options:{xResponse:1,yResponse:1,scaleResponse:1,z:0},_dirtyRects:[],_changedObjs:[],layerCount:0,_dirtyViewport:!1,_sort:function(t,e){return t._globalZ-e._globalZ},dirty:function(t){this._changedObjs.push(t)},attach:function(t){t._drawContext=this.context,this.layerCount++},detach:function(t){this.dirty(t),t._drawContext=null,this.layerCount--},context:null,_canvas:null,init:function(){if(!n.support.canvas)return n.trigger("NoCanvas"),void n.stop();this._dirtyRects=[],this._changedObjs=[];var t;t=document.createElement("canvas"),t.width=n.viewport.width,t.height=n.viewport.height,t.style.position="absolute",t.style.left="0px",t.style.top="0px",t.style.zIndex=this.options.z,n.stage.elem.appendChild(t),this.context=t.getContext("2d"),this._canvas=t;var e=n.viewport._scale;1!==e&&this.context.scale(e,e),this._setPixelart(n._pixelartEnabled),this.uniqueBind("PixelartSet",this._setPixelart),this.uniqueBind("RenderScene",this._render),this.uniqueBind("ViewportResize",this._resize),this.bind("InvalidateViewport",function(){this._dirtyViewport=!0}),n._addDrawLayerInstance(this)},remove:function(){this._canvas.parentNode.removeChild(this._canvas),n._removeDrawLayerInstance(this)},_render:function(){var t=this._dirtyViewport,e=this._changedObjs.length,i=this.context;if(e||t){var n=this.options;if(t&&n){var r=this._viewportRect(),s=r._scale,o=-r._x*s,a=-r._y*s;i.setTransform(s,0,0,s,Math.round(o),Math.round(a))}e/this.layerCount>.6||t?this._drawAll():this._drawDirty(),this._clean()}},_drawDirty:function(t){t=t||this._viewportRect();var e,i,r,s,o,a,h=this._changedObjs,u=h.length,c=this._dirtyRects,l=n.rectManager,d=l.overlap,_=this.context,p=[],f=[];for(t=l.integerBounds(t),e=0;e<u;e++)this._createDirty(h[e]);for(l.mergeSet(c),u=c.length,e=0;e<u;++e)if(s=c[e],p.length=0,f.length=0,s&&(s=l.integerBounds(s),d(s,t))){for(r=n.map.search(s,!1),_.clearRect(s._x,s._y,s._w,s._h),_.save(),_.beginPath(),_.rect(s._x,s._y,s._w,s._h),_.clip(),i=0,o=r.length;i<o;++i)a=r[i],!p[a[0]]&&a._visible&&a._drawLayer===this&&(p[a[0]]=!0,f.push(a));for(f.sort(this._sort),i=0,o=f.length;i<o;++i){a=f[i];var g=a._mbr||a;d(g,s)&&a.draw(),a._changed=!1}_.closePath(),_.restore()}if(!0===this.debugDirty)for(_.strokeStyle="red",e=0,u=c.length;e<u;++e)s=c[e],_.strokeRect(s._x,s._y,s._w,s._h)},_drawAll:function(t){t=t||this._viewportRect(),t=n.rectManager.integerBounds(t);var e,i=n.map.search(t),r=0,s=i.length,o=this.context;for(o.clearRect(t._x,t._y,t._w,t._h),i.sort(this._sort);r<s;r++)e=i[r],e._visible&&e._drawContext===this.context&&(e.draw(this.context),e._changed=!1)},debug:function(){n.log(this._changedObjs)},_clean:function(){var t,e,i,n,r=this._changedObjs;for(i=0,n=r.length;i<n;i++)e=r[i],t=e._mbr||e,void 0===e.staleRect&&(e.staleRect={}),e.staleRect._x=t._x,e.staleRect._y=t._y,e.staleRect._w=t._w,e.staleRect._h=t._h,e._changed=!1;r.length=0,this._dirtyRects.length=0,this._dirtyViewport=!1},_createDirty:function(t){var e=t._mbr||t,i=this._dirtyRects,r=n.rectManager;if(t.staleRect){if(r.overlap(t.staleRect,e))return r.merge(t.staleRect,e,t.staleRect),void i.push(t.staleRect);i.push(t.staleRect)}t.currentRect._x=e._x,t.currentRect._y=e._y,t.currentRect._w=e._w,t.currentRect._h=e._h,i.push(t.currentRect)},_resize:function(){var t=this._canvas;t.width=n.viewport.width,t.height=n.viewport.height},_setPixelart:function(t){var e=this.context;e.imageSmoothingEnabled=!t,e.mozImageSmoothingEnabled=!t,e.webkitImageSmoothingEnabled=!t,e.oImageSmoothingEnabled=!t,e.msImageSmoothingEnabled=!t}})},{"../core/core.js":9}],23:[function(t,e,i){var n=t("../core/core.js");n.c("Canvas",{init:function(){this.requires("Renderable"),this.currentRect={},this._customLayer||this._attachToLayer(n.s("DefaultCanvasLayer"))},remove:function(){this._detachFromLayer()},drawVars:{type:"canvas",pos:{},ctx:null,coord:[0,0,0,0],co:{x:0,y:0,w:0,h:0}},draw:function(t,e,i,n,r){if(this.ready){4===arguments.length&&(r=n,n=i,i=e,e=t,t=this._drawContext);var s=this.drawVars.pos;s._x=this._x+(e||0),s._y=this._y+(i||0),s._w=n||this._w,s._h=r||this._h;var o=t||this._drawContext,a=this.__coord||[0,0,0,0],h=this.drawVars.co;h.x=a[0]+(e||0),h.y=a[1]+(i||0),h.w=n||a[2],h.h=r||a[3],(this._flipX||this._flipY||this._rotation)&&o.save(),0!==this._rotation&&(o.translate(this._origin.x+this._x,this._origin.y+this._y),s._x=-this._origin.x,s._y=-this._origin.y,o.rotate(this._rotation%360*(Math.PI/180))),(this._flipX||this._flipY)&&(o.scale(this._flipX?-1:1,this._flipY?-1:1),this._flipX&&(s._x=-(s._x+s._w)),this._flipY&&(s._y=-(s._y+s._h)));var u;return this._alpha<1&&(u=o.globalAlpha,o.globalAlpha=this._alpha),this.drawVars.ctx=o,this.trigger("Draw",this.drawVars),(0!==this._rotation||this._flipX||this._flipY)&&o.restore(),u&&(o.globalAlpha=u),this}}})},{"../core/core.js":9}],24:[function(t,e,i){var n=t("../core/core.js"),r=window.document;n.extend({assignColor:function(){function t(t){return t._red=t._blue=t._green=0,t}function e(t){var e=t.toString(16);return 1===e.length&&(e="0"+e),e}function i(t,i,n){return"#"+e(t)+e(i)+e(n)}function n(e,i){var n,r,s,o=e.length;if(7===o)n=e.substr(1,2),r=e.substr(3,2),s=e.substr(5,2);else{if(4!==o)return t(i);n=e.substr(1,1),n+=n,r=e.substr(2,1),r+=r,s=e.substr(3,1),s+=s}return i._red=parseInt(n,16),i._green=parseInt(r,16),i._blue=parseInt(s,16),i}function s(e,i){var n=l.exec(e);return null===n||4!==n.length&&5!==n.length?t(i):(i._red=Math.round(parseFloat(n[1])),i._green=Math.round(parseFloat(n[2])),i._blue=Math.round(parseFloat(n[3])),n[4]&&(i._strength=parseFloat(n[4])),i)}function o(t,e){if(void 0===c[t]){!1===u&&(window.document.body.appendChild(h),u=!0),h.style.color=t;s(window.getComputedStyle(h).color,e),c[t]=i(e._red,e._green,e._blue)}else n(c[t],e);return e}function a(t){return"rgba("+t._red+", "+t._green+", "+t._blue+", "+t._strength+")"}var h=r.createElement("div");h.style.display="none";var u=!1,c={aqua:"#00ffff",black:"#000000",blue:"#0000ff",fuchsia:"#ff00ff",gray:"#808080",green:"#00ff00",lime:"#00ff00",maroon:"#800000",navy:"#000080",olive:"#808000",orange:"#ffa500",purple:"#800080",red:"#ff0000",silver:"#c0c0c0",teal:"#008080",white:"#ffffff",yellow:"#ffff00"},l=/rgba?\s*\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,?\s*([0-9.]+)?\)/;return function(t,e){e=e||{},t=t.trim().toLowerCase();"#"===t[0]?n(t,e):"r"===t[0]&&"g"===t[1]&&"b"===t[2]?s(t,e):o(t,e),e._strength=e._strength||1,e._color=a(e)}}()}),n.defaultShader("Color",new n.WebGLShader("attribute vec2 aPosition;\nattribute vec3 aOrientation;\nattribute vec2 aLayer;\nattribute vec4 aColor;\n\nvarying lowp vec4 vColor;\n\nuniform  vec4 uViewport;\n\nmat4 viewportScale = mat4(2.0 / uViewport.z, 0, 0, 0,    0, -2.0 / uViewport.w, 0,0,    0, 0,1,0,    -1,+1,0,1);\nvec4 viewportTranslation = vec4(uViewport.xy, 0, 0);\n\nvoid main() {\n  vec2 pos = aPosition;\n  vec2 entityOrigin = aOrientation.xy;\n  mat2 entityRotationMatrix = mat2(cos(aOrientation.z), sin(aOrientation.z), -sin(aOrientation.z), cos(aOrientation.z));\n\n  pos = entityRotationMatrix * (pos - entityOrigin) + entityOrigin;\n  gl_Position = viewportScale * (viewportTranslation + vec4(pos, 1.0/(1.0+exp(aLayer.x) ), 1) );\n  vColor = vec4(aColor.rgb*aColor.a*aLayer.y, aColor.a*aLayer.y);\n}","precision mediump float;\nvarying lowp vec4 vColor;\nvoid main(void) {\n\tgl_FragColor = vColor;\n}",[{name:"aPosition",width:2},{name:"aOrientation",width:3},{name:"aLayer",width:2},{name:"aColor",width:4}],function(t,e){t.program.writeVector("aColor",e._red/255,e._green/255,e._blue/255,e._strength)})),n.c("Color",{_red:0,_green:0,_blue:0,_strength:1,_color:"",ready:!0,init:function(){this.bind("Draw",this._drawColor),this._drawLayer&&this._setupColor(this._drawLayer),this.trigger("Invalidate")},events:{LayerAttached:"_setupColor"},remove:function(){this.unbind("Draw",this._drawColor),this.has("DOM")&&(this._element.style.backgroundColor="transparent"),this.trigger("Invalidate")},_setupColor:function(t){"WebGL"===t.type&&this._establishShader("Color",n.defaultShader("Color"))},_drawColor:function(t){this._color&&("DOM"===t.type?(t.style.backgroundColor=this._color,t.style.lineHeight=0):"canvas"===t.type?(t.ctx.fillStyle=this._color,t.ctx.fillRect(t.pos._x,t.pos._y,t.pos._w,t.pos._h)):"webgl"===t.type&&t.program.draw(t,this))},color:function(t){return 0===arguments.length?this._color:(arguments.length>=3?(this._red=arguments[0],this._green=arguments[1],this._blue=arguments[2],"number"==typeof arguments[3]&&(this._strength=arguments[3])):(n.assignColor(t,this),"number"==typeof arguments[1]&&(this._strength=arguments[1])),this._color="rgba("+this._red+", "+this._green+", "+this._blue+", "+this._strength+")",this.trigger("Invalidate"),this)}})},{"../core/core.js":9}],25:[function(t,e,i){var n=t("../core/core.js"),r=window.document;n.extend({domHelper:{innerPosition:function(t){var e=t.getBoundingClientRect(),i=e.left+(window.pageXOffset?window.pageXOffset:r.body.scrollLeft),n=e.top+(window.pageYOffset?window.pageYOffset:r.body.scrollTop),s=parseInt(this.getStyle(t,"border-left-width")||0,10)||parseInt(this.getStyle(t,"borderLeftWidth")||0,10)||0,o=parseInt(this.getStyle(t,"border-top-width")||0,10)||parseInt(this.getStyle(t,"borderTopWidth")||0,10)||0;return i+=s,n+=o,{x:i,y:n}},getStyle:function(t,e){var i;return t.currentStyle?i=t.currentStyle[this.camelize(e)]:window.getComputedStyle&&(i=r.defaultView.getComputedStyle(t,null).getPropertyValue(this.csselize(e))),i},camelize:function(t){return t.replace(/-+(.)?/g,function(t,e){return e?e.toUpperCase():""})},csselize:function(t){return t.replace(/[A-Z]/g,function(t){return t?"-"+t.toLowerCase():""})},translate:function(t,e,i){var s,o=r.documentElement,a=r.body;return i?(s=i._viewportRect(),{x:(t-n.stage.x+(o&&o.scrollLeft||a&&a.scrollLeft||0))/s._scale+s._x,y:(e-n.stage.y+(o&&o.scrollTop||a&&a.scrollTop||0))/s._scale+s._y}):(s=n.viewport,{x:(t-n.stage.x+(o&&o.scrollLeft||a&&a.scrollLeft||0))/s._scale-s._x,y:(e-n.stage.y+(o&&o.scrollTop||a&&a.scrollTop||0))/s._scale-s._y})}}})},{"../core/core.js":9}],26:[function(t,e,i){var n=t("../core/core.js"),r=window.document;n._registerLayerTemplate("DOM",{type:"DOM",options:{xResponse:1,yResponse:1,scaleResponse:1,z:0},_changedObjs:[],_dirtyViewport:!1,_div:null,init:function(){this._changedObjs=[];var t=this._div=r.createElement("div");n.stage.elem.appendChild(t),t.style.position="absolute",t.style.zIndex=this.options.z,t.style.transformStyle="preserve-3d",this.uniqueBind("RenderScene",this._render),this.uniqueBind("PixelartSet",this._setPixelArt),this.uniqueBind("InvalidateViewport",function(){this._dirtyViewport=!0}),n._addDrawLayerInstance(this)},remove:function(){this._div.parentNode.removeChild(this._div),n._removeDrawLayerInstance(this)},_setPixelArt:function(t){var e=this._div.style,i=n.domHelper.camelize;t?(e[i("image-rendering")]="optimizeSpeed",e[i("image-rendering")]="-moz-crisp-edges",e[i("image-rendering")]="-o-crisp-edges",e[i("image-rendering")]="-webkit-optimize-contrast",e[i("-ms-interpolation-mode")]="nearest-neighbor",e[i("image-rendering")]="optimize-contrast",e[i("image-rendering")]="pixelated",e[i("image-rendering")]="crisp-edges"):(e[i("image-rendering")]="optimizeQuality",e[i("-ms-interpolation-mode")]="bicubic",e[i("image-rendering")]="auto")},debug:function(){n.log(this._changedObjs)},_render:function(){var t=this._changedObjs;if(this._dirtyViewport&&(this._setViewport(),this._dirtyViewport=!1),t.length){for(var e=0,i=t.length;e<i;++e)t[e].draw()._changed=!1;t.length=0}},dirty:function(t){this._changedObjs.push(t)},attach:function(t){t._drawContext=this.context,this._div.appendChild(t._element),t._element.style.position="absolute",t._element.id="ent"+t[0]},detach:function(t){this._div.removeChild(t._element)},_setViewport:function(){var t=this._div.style,e=this._viewportRect(),i=e._scale,r=-e._x*i,s=-e._y*i;t.transform=t[n.support.prefix+"Transform"]="scale("+i+", "+i+")",t.left=Math.round(r)+"px",t.top=Math.round(s)+"px",t.zIndex=this.options.z}})},{"../core/core.js":9}],27:[function(t,e,i){var n=t("../core/core.js"),r=window.document;n.c("DOM",{_element:null,_cssStyles:null,avoidCss3dTransforms:!1,init:function(){this.requires("Renderable"),this._cssStyles={visibility:"",left:"",top:"",width:"",height:"",zIndex:"",opacity:"",transformOrigin:"",transform:""},this._element=r.createElement("div"),this._customLayer||this._attachToLayer(n.s("DefaultDOMLayer")),this.bind("NewComponent",this._updateClass),this.bind("RemoveComponent",this._removeClass)},remove:function(){this._detachFromLayer(),this.unbind("NewComponent",this._updateClass),this.unbind("RemoveComponent",this._removeClass)},getDomId:function(){return this._element.id},_removeClass:function(t){var e,i=this.__c,n="";for(e in i)e!==t&&(n+=" "+e);n=n.substr(1),this._element.className=n},_updateClass:function(){var t,e=this.__c,i="";for(t in e)i+=" "+t;i=i.substr(1),this._element.className=i},DOM:function(t){if(t&&t.nodeType){var e=this._drawLayer;this._detachFromLayer(),this._element=t,this._attachToLayer(e)}return this},draw:function(){var t=this._element.style,e=this.__coord||[0,0,0,0],i={x:e[0],y:e[1],w:e[2],h:e[3]},r=n.support.prefix,s=[];if(this._cssStyles.visibility!==this._visible&&(this._cssStyles.visibility=this._visible,this._visible?t.visibility="visible":t.visibility="hidden"),n.support.css3dtransform&&!this.avoidCss3dTransforms?s.push("translate3d("+~~this._x+"px,"+~~this._y+"px,0)"):(this._cssStyles.left!==this._x&&(this._cssStyles.left=this._x,t.left=~~this._x+"px"),this._cssStyles.top!==this._y&&(this._cssStyles.top=this._y,t.top=~~this._y+"px")),this._cssStyles.width!==this._w&&(this._cssStyles.width=this._w,t.width=~~this._w+"px"),this._cssStyles.height!==this._h&&(this._cssStyles.height=this._h,t.height=~~this._h+"px"),this._cssStyles.zIndex!==this._z&&(this._cssStyles.zIndex=this._z,t.zIndex=this._z),this._cssStyles.opacity!==this._alpha&&(this._cssStyles.opacity=this._alpha,t.opacity=this._alpha,t[r+"Opacity"]=this._alpha),this._mbr){var o=this._origin.x+"px "+this._origin.y+"px";t.transformOrigin=o,t[r+"TransformOrigin"]=o,n.support.css3dtransform?s.push("rotateZ("+this._rotation+"deg)"):s.push("rotate("+this._rotation+"deg)")}return this._flipX&&s.push("scaleX(-1)"),this._flipY&&s.push("scaleY(-1)"),this._cssStyles.transform!==s.join(" ")&&(this._cssStyles.transform=s.join(" "),t.transform=this._cssStyles.transform,t[r+"Transform"]=this._cssStyles.transform),this.trigger("Draw",{style:t,type:"DOM",co:i}),this},css:function(t,e){var i,r,s=this._element,a=s.style;if("object"===(void 0===t?"undefined":o(t)))for(i in t)t.hasOwnProperty(i)&&(r=t[i],"number"==typeof r&&(r+="px"),a[n.domHelper.camelize(i)]=r);else{if(!e)return n.domHelper.getStyle(s,t);"number"==typeof e&&(e+="px"),a[n.domHelper.camelize(t)]=e}return this.trigger("Invalidate"),this}})},{"../core/core.js":9}],28:[function(t,e,i){var n=t("../core/core.js");n.extend({_pixelartEnabled:!1,pixelart:function(t){n._pixelartEnabled=t,n.trigger("PixelartSet",t)}})},{"../core/core.js":9}],29:[function(t,e,i){function n(t,e){this.gl=t,this.webgl=e,this.max_units=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.bound_textures=[],this.registered_textures={},this.active=null}function r(t,e){this.manager=t,this.gl=t.gl,this.glTexture=this.gl.createTexture(),this.id=e,this.active=!1,this.unit=null,this.powerOfTwo=!1}var s=t("../core/core.js");s.TextureManager=n,n.prototype={reset:function(){for(var t,e=0;e<this.bound_textures.length;e++)t=this.bound_textures[e],t.unbind();this.bound_textures=[],this.active=null},makeTexture:function(t,e,i){var n=this.webgl,s="texture-(r:"+i+")-"+t;if(void 0!==this.registered_textures[s])return this.registered_textures[s];var o=new r(this,s);return this.registered_textures[s]=o,this.bindTexture(o),o.setImage(e),o.setFilter(n.texture_filter),o.setRepeat(i),o},smallest:function(){for(var t=1/0,e=null,i=0;i<this.bound_textures.length;i++){var n=this.bound_textures[i];n.size<t&&(t=n.size,e=i)}return e},getAvailableUnit:function(){return this.bound_textures.length<this.max_units?this.bound_textures.length:this.smallest()},bindTexture:function(t){if(null===t.unit){var e=this.getAvailableUnit();this.bound_textures[e]&&this.unbindTexture(this.bound_textures[e]),this.bound_textures[e]=t,t.bind(e)}},unbindTexture:function(t){t.unbind()},setActiveTexture:function(t){this.active!==t.id&&(this.gl.activeTexture(this.gl[t.name]),this.active=t.unit)}},s.TextureWrapper=r,r.prototype={bind:function(t){var e=this.gl;this.unit=t,this.name="TEXTURE"+t,this.manager.setActiveTexture(this),e.bindTexture(e.TEXTURE_2D,this.glTexture)},isActive:function(){return this.manager.active===this.unit},unbind:function(){this.unit=null,this.name=null,this.isActive()&&(this.manager.active=null)},setImage:function(t){if(!this.isActive())throw"Trying to set image of texture that isn't active";this.width=t.width,this.height=t.height,this.size=t.width*t.height,this.powerOfTwo=!(Math.log(t.width)/Math.LN2!==Math.floor(Math.log(t.width)/Math.LN2)||Math.log(t.height)/Math.LN2!==Math.floor(Math.log(t.height)/Math.LN2));var e=this.gl;e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t)},setFilter:function(t){if(!this.isActive())throw"Trying to set filter of texture that isn't active";var e=this.gl;e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,t)},setRepeat:function(t){if(!this.isActive())throw"Trying to set repeat property of texture that isn't active";if(t&&!this.powerOfTwo)throw"Can't create a repeating image whose dimensions aren't a power of 2 in WebGL contexts";var e=this.gl;this.repeatMode=t?e.REPEAT:e.CLAMP_TO_EDGE,e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,this.repeatMode),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,this.repeatMode)},setToProgram:function(t,e,i){if(null===this.unit)throw"Trying to use texture not set to a texture unit.";var n=this.gl;n.useProgram(t),n.uniform1i(n.getUniformLocation(t,e),this.unit),n.uniform2f(n.getUniformLocation(t,i),this.width,this.height)}}},{"../core/core.js":9}],30:[function(t,e,i){t("../core/core.js").c("HTML",{inner:"",init:function(){this.requires("2D, DOM")},replace:function(t){return this.inner=t,this._element.innerHTML=t,this},append:function(t){return this.inner+=t,this._element.innerHTML+=t,this},prepend:function(t){return this.inner=t+this.inner,this._element.innerHTML=t+this.inner,this}})},{"../core/core.js":9}],31:[function(t,e,i){var n=t("../core/core.js");n.defaultShader("Image",new n.WebGLShader("attribute vec2 aPosition;\nattribute vec3 aOrientation;\nattribute vec2 aLayer;\nattribute vec2 aTextureCoord;\n\nvarying mediump vec3 vTextureCoord;\n\nuniform vec4 uViewport;\nuniform mediump vec2 uTextureDimensions;\n\nmat4 viewportScale = mat4(2.0 / uViewport.z, 0, 0, 0,    0, -2.0 / uViewport.w, 0,0,    0, 0,1,0,    -1,+1,0,1);\nvec4 viewportTranslation = vec4(uViewport.xy, 0, 0);\n\nvoid main() {\n  vec2 pos = aPosition;\n  vec2 entityOrigin = aOrientation.xy;\n  mat2 entityRotationMatrix = mat2(cos(aOrientation.z), sin(aOrientation.z), -sin(aOrientation.z), cos(aOrientation.z));\n  \n  pos = entityRotationMatrix * (pos - entityOrigin) + entityOrigin ;\n  gl_Position = viewportScale * (viewportTranslation + vec4(pos, 1.0/(1.0+exp(aLayer.x) ), 1) );\n  vTextureCoord = vec3(aTextureCoord, aLayer.y);\n}","varying mediump vec3 vTextureCoord;\n  \nuniform sampler2D uSampler;\nuniform mediump vec2 uTextureDimensions;\n\nvoid main(void) {\n  highp vec2 coord =   vTextureCoord.xy / uTextureDimensions;\n  mediump vec4 base_color = texture2D(uSampler, coord);\n  gl_FragColor = vec4(base_color.rgb*base_color.a*vTextureCoord.z, base_color.a*vTextureCoord.z);\n}",[{name:"aPosition",width:2},{name:"aOrientation",width:3},{name:"aLayer",width:2},{name:"aTextureCoord",width:2}],function(t,e){var i=t.pos;t.program.writeVector("aTextureCoord",0,0,0,i._h,i._w,0,i._w,i._h)})),n.c("Image",{_repeat:"repeat",ready:!1,init:function(){this.bind("Draw",this._drawImage),this.bind("LayerAttached",this._setupImage)},remove:function(){this.unbind("LayerAttached",this._setupImage),this.unbind("Draw",this._drawImage)},image:function(t,e){if(this.__image=t,this._repeat=e||"no-repeat",this.img=n.asset(t),this.img)this._setupImage(this._drawLayer);else{this.img=new Image,n.asset(t,this.img),this.img.src=t;var i=this;this.img.onload=function(){i._setupImage(i._drawLayer)}}return this.trigger("Invalidate"),this},_setupImage:function(t){this.img&&t&&("Canvas"===t.type?this._pattern=this._drawContext.createPattern(this.img,this._repeat):"WebGL"===t.type&&(this._establishShader("image:"+this.__image,n.defaultShader("Image")),this.program.setTexture(this._drawLayer.makeTexture(this.__image,this.img,"no-repeat"!==this._repeat))),"no-repeat"===this._repeat&&(this.w=this.w||this.img.width,this.h=this.h||this.img.height),this.ready=!0,this.trigger("Invalidate"))},_drawImage:function(t){if("canvas"===t.type){if(!this.ready||!this._pattern)return;var e=t.ctx;e.fillStyle=this._pattern,e.save(),e.translate(t.pos._x,t.pos._y),e.fillRect(0,0,t.pos._w,t.pos._h),e.restore()}else"DOM"===t.type?this.__image&&(t.style.backgroundImage="url("+this.__image+")",t.style.backgroundRepeat=this._repeat):"webgl"===t.type&&t.program.draw(t,this)}})},{"../core/core.js":9}],32:[function(t,e,i){var n=t("../core/core.js");n.extend({_drawLayerTemplates:{},_drawLayers:[],_addDrawLayerInstance:function(t){n._drawLayers.push(t),this._drawLayers.sort(function(t,e){return t.options.z-e.options.z})},_removeDrawLayerInstance:function(t){var e=this._drawLayers.indexOf(t);e>=0&&this._drawLayers.splice(e,1),this._drawLayers.sort(function(t,e){return t.options.z-e.options.z})},_registerLayerTemplate:function(t,e){this._drawLayerTemplates[t]=e;var i=this._commonLayerProperties;for(var n in i)e[n]||(e[n]=i[n]);e._viewportRectHolder={}},_commonLayerProperties:{_viewportRect:function(){var t=this.options,e=this._viewportRectHolder,i=Math.pow(n.viewport._scale,t.scaleResponse),r=n.viewport;return e._scale=i,e._w=r._width/i,e._h=r._height/i,e._x=t.xResponse*-r._x-.5*(t.xResponse-1)*(1-1/i)*r._width,e._y=t.yResponse*-r._y-.5*(t.yResponse-1)*(1-1/i)*r._height,e},_pointerEntities:0},createLayer:function(t,e,i){var r=this._drawLayerTemplates[e];n.s(t,r,i),n.c(t,{init:function(){this.requires("Renderable"),this._customLayer=!0,this.requires(r.type),this._attachToLayer(n.s(t))},remove:function(){this._detachFromLayer()}})}})},{"../core/core.js":9}],33:[function(t,e,i){var n=t("../core/core.js"),r=window.document;n.c("Particles",{init:function(){this._Particles=n.clone(this._Particles),this._Particles.parentEntity=this,this._particlesPaused=!1},particles:function(t){if(!n.support.canvas||n.deactivateParticles)return this;var e,i,s,o,a;e=r.createElement("canvas"),e.width=n.viewport.width,e.height=n.viewport.height,e.style.position="absolute",e.style.left="0px",e.style.top="0px",n.stage.elem.appendChild(e),i=e.getContext("2d"),this._Particles.init(t),this.bind("Remove",function(){n.stage.elem.removeChild(e)}).bind("RemoveComponent",function(t){"particles"===t&&n.stage.elem.removeChild(e)}),s=this.x+n.viewport.x,o=this.y+n.viewport.y,this._Particles.position=this._Particles.vectorHelpers.create(s,o);var h={x:n.viewport.x,y:n.viewport.y};return this.bind("EnterFrame",function(){this._particlesPaused||(s=this.x+n.viewport.x,o=this.y+n.viewport.y,this._Particles.viewportDelta={x:n.viewport.x-h.x,y:n.viewport.y-h.y},h={x:n.viewport.x,y:n.viewport.y},this._Particles.position=this._Particles.vectorHelpers.create(s,o),"function"==typeof n.rectManager.boundingRect?(a=n.rectManager.boundingRect(this._Particles.register))&&i.clearRect(a._x,a._y,a._w,a._h):i.clearRect(0,0,n.viewport.width,n.viewport.height),this._Particles.update(),this._Particles.render(i))}),this},_Particles:{presets:{maxParticles:150,size:18,sizeRandom:4,speed:1,speedRandom:1.2,lifeSpan:29,lifeSpanRandom:7,angle:65,angleRandom:34,startColour:[255,131,0,1],startColourRandom:[48,50,45,0],endColour:[245,35,0,0],endColourRandom:[60,60,60,0],sharpness:20,sharpnessRandom:10,spread:10,duration:-1,fastMode:!1,gravity:{x:0,y:.1},jitter:0,originOffset:{x:0,y:0},particles:[],active:!0,particleCount:0,elapsedFrames:0,emissionRate:0,emitCounter:0,particleIndex:0},init:function(t){this.position=this.vectorHelpers.create(0,0),void 0===t&&(t={});for(var e in this.presets)void 0!==t[e]?this[e]=t[e]:this[e]=this.presets[e];this.emissionRate=this.maxParticles/this.lifeSpan,this.positionRandom=this.vectorHelpers.create(this.spread,this.spread)},addParticle:function(){if(this.particleCount===this.maxParticles)return!1;var t=new this.particle(this.vectorHelpers);return this.initParticle(t),this.particles[this.particleCount]=t,this.particleCount++,!0},RANDM1TO1:function(){return 2*Math.random()-1},initParticle:function(t){t.position.x=n.viewport._scale*(this.position.x+this.originOffset.x+this.positionRandom.x*this.RANDM1TO1()),t.position.y=n.viewport._scale*(this.position.y+this.originOffset.y+this.positionRandom.y*this.RANDM1TO1());var e=(this.angle+this.angleRandom*this.RANDM1TO1())*(Math.PI/180),i=this.vectorHelpers.create(Math.sin(e),-Math.cos(e)),r=this.speed+this.speedRandom*this.RANDM1TO1();t.direction=this.vectorHelpers.multiply(i,r),t.size=n.viewport._scale*(this.size+this.sizeRandom*this.RANDM1TO1()),t.size=t.size<0?0:~~t.size,t.timeToLive=this.lifeSpan+this.lifeSpanRandom*this.RANDM1TO1(),t.sharpness=this.sharpness+this.sharpnessRandom*this.RANDM1TO1(),t.sharpness=t.sharpness>100?100:t.sharpness<0?0:t.sharpness,t.sizeSmall=~~(t.size/200*t.sharpness);var s=[this.startColour[0]+this.startColourRandom[0]*this.RANDM1TO1(),this.startColour[1]+this.startColourRandom[1]*this.RANDM1TO1(),this.startColour[2]+this.startColourRandom[2]*this.RANDM1TO1(),this.startColour[3]+this.startColourRandom[3]*this.RANDM1TO1()],o=[this.endColour[0]+this.endColourRandom[0]*this.RANDM1TO1(),this.endColour[1]+this.endColourRandom[1]*this.RANDM1TO1(),this.endColour[2]+this.endColourRandom[2]*this.RANDM1TO1(),this.endColour[3]+this.endColourRandom[3]*this.RANDM1TO1()];t.colour=s,t.deltaColour[0]=(o[0]-s[0])/t.timeToLive,t.deltaColour[1]=(o[1]-s[1])/t.timeToLive,t.deltaColour[2]=(o[2]-s[2])/t.timeToLive,t.deltaColour[3]=(o[3]-s[3])/t.timeToLive},update:function(){if(this.active&&this.emissionRate>0){var t=1/this.emissionRate;for(this.emitCounter++;this.particleCount<this.maxParticles&&this.emitCounter>t;)this.addParticle(),this.emitCounter-=t;this.elapsedFrames++,-1!==this.duration&&this.duration<this.elapsedFrames&&this.stop()}this.particleIndex=0,this.register=[];for(var e;this.particleIndex<this.particleCount;){var i=this.particles[this.particleIndex];if(i.timeToLive>0){i.direction=this.vectorHelpers.add(i.direction,this.gravity),i.position=this.vectorHelpers.add(i.position,i.direction),i.position=this.vectorHelpers.add(i.position,this.viewportDelta),this.jitter&&(i.position.x+=this.jitter*this.RANDM1TO1(),i.position.y+=this.jitter*this.RANDM1TO1()),i.timeToLive--;var n=i.colour[0]+=i.deltaColour[0],r=i.colour[1]+=i.deltaColour[1],s=i.colour[2]+=i.deltaColour[2],o=i.colour[3]+=i.deltaColour[3];e=[],e.push("rgba("+(n>255?255:n<0?0:~~n)),e.push(r>255?255:r<0?0:~~r),e.push(s>255?255:s<0?0:~~s),e.push((o>1?1:o<0?0:o.toFixed(2))+")"),i.drawColour=e.join(","),this.fastMode||(e[3]="0)",i.drawColourEnd=e.join(",")),this.particleIndex++}else this.particleIndex!==this.particleCount-1&&(this.particles[this.particleIndex]=this.particles[this.particleCount-1]),this.particleCount--;var a={};a._x=~~i.position.x,a._y=~~i.position.y,a._w=i.size,a._h=i.size,this.register.push(a)}},stop:function(){this.active=!1,this.elapsedFrames=0,this.emitCounter=0,this.parentEntity.trigger("ParticleEnd")},render:function(t){for(var e=0,i=this.particleCount;e<i;e++){var r=this.particles[e],s=r.size,o=s>>1;if(!(r.position.x+s<0||r.position.y+s<0||r.position.x-s>n.viewport.width||r.position.y-s>n.viewport.height)){var a=~~r.position.x,h=~~r.position.y;if(this.fastMode)t.fillStyle=r.drawColour;else{var u=t.createRadialGradient(a+o,h+o,r.sizeSmall,a+o,h+o,o);u.addColorStop(0,r.drawColour),u.addColorStop(.9,r.drawColourEnd),t.fillStyle=u}t.fillRect(a,h,s,s)}}},particle:function(t){this.position=t.create(0,0),this.direction=t.create(0,0),this.size=0,this.sizeSmall=0,this.timeToLive=0,this.colour=[],this.drawColour="",this.deltaColour=[],this.sharpness=0},vectorHelpers:{create:function(t,e){return{x:t,y:e}},multiply:function(t,e){return t.x*=e,t.y*=e,t},add:function(t,e){return t.x+=e.x,t.y+=e.y,t}}},pauseParticles:function(){this._particlesPaused=!0},resumeParticles:function(){this._particlesPaused=!1}})},{"../core/core.js":9}],34:[function(t,e,i){t("../core/core.js").c("Renderable",{_changed:!1,_alpha:1,_visible:!0,_setterRenderable:function(t,e){this[t]!==e&&(this[t]=e,this.trigger("Invalidate"))},_graphics_property_definitions:{alpha:{set:function(t){this._setterRenderable("_alpha",t)},get:function(){return this._alpha},configurable:!0,enumerable:!0},_alpha:{enumerable:!1},visible:{set:function(t){this._setterRenderable("_visible",t)},get:function(){return this._visible},configurable:!0,enumerable:!0},_visible:{enumerable:!1}},_defineRenderableProperites:function(){for(var t in this._graphics_property_definitions)Object.defineProperty(this,t,this._graphics_property_definitions[t])},init:function(){this._defineRenderableProperites()},_invalidateRenderable:function(){!1===this._changed&&(this._changed=!0,this._drawLayer.dirty(this))},_attachToLayer:function(t){this._drawLayer&&this._detachFromLayer(),this._drawLayer=t,t.attach(this),this.bind("Invalidate",this._invalidateRenderable),this.trigger("LayerAttached",t),this.trigger("Invalidate")},_detachFromLayer:function(){this._drawLayer&&(this._drawLayer.detach(this),this.unbind("Invalidate",this._invalidateRenderable),this.trigger("LayerDetached",this._drawLayer),delete this._drawLayer)},flip:function(t){return t=t||"X",this["_flip"+t]||(this["_flip"+t]=!0,this.trigger("Invalidate")),this},unflip:function(t){return t=t||"X",this["_flip"+t]&&(this["_flip"+t]=!1,this.trigger("Invalidate")),this}})},{"../core/core.js":9}],35:[function(t,e,i){var n=t("../core/core.js");n.c("SpriteAnimation",{_reels:null,_currentReelId:null,_currentReel:null,_isPlaying:!1,animationSpeed:1,init:function(){this._reels={}},reel:function(t,e,i,r,s,a){if(0===arguments.length)return this._currentReelId;if(1===arguments.length&&"string"==typeof t){if(void 0===this._reels[t])throw"The specified reel "+t+" is undefined.";return this.pauseAnimation(),this._currentReelId!==t&&(this._currentReelId=t,this._currentReel=this._reels[t],this._updateSprite(),this.trigger("ReelChange",this._currentReel)),this}var h,u;if(h={id:t,frames:[],currentFrame:0,easing:new n.easing(e),defaultLoops:1},h.duration=h.easing.duration,"number"==typeof i)if(a=a||1/0,s>=0)for(u=0;u<s;++u)h.frames.push([i,r]),++i>=a&&(i=0,r++);else for(u=0;u>s;--u)h.frames.push([i,r]),--i<0&&(i=a-1,r--);else{if(3!==arguments.length||"object"!==(void 0===i?"undefined":o(i)))throw"Unrecognized arguments. Please see the documentation for 'reel(...)'.";h.frames=i}return this._reels[t]=h,this},animate:function(t,e){"string"==typeof t&&this.reel(t);var i=this._currentReel;if(void 0===i||null===i)throw"No reel is specified, and there is no currently active reel.";return this.pauseAnimation(),void 0===e&&(e="number"==typeof t?t:1),i.easing.reset(),this.loops(e),this._setFrame(0),this.bind("EnterFrame",this._animationTick),this._isPlaying=!0,this.trigger("StartAnimation",i),this},resumeAnimation:function(){return!1===this._isPlaying&&null!==this._currentReel&&(this.bind("EnterFrame",this._animationTick),this._isPlaying=!0,this._currentReel.easing.resume(),this.trigger("StartAnimation",this._currentReel)),this},pauseAnimation:function(){return!0===this._isPlaying&&(this.unbind("EnterFrame",this._animationTick),this._isPlaying=!1,this._reels[this._currentReelId].easing.pause()),this},resetAnimation:function(){var t=this._currentReel;if(null===t)throw"No active reel to reset.";return this.reelPosition(0),t.easing.repeat(t.defaultLoops),this},loops:function(t){return 0===arguments.length?null!==this._currentReel?this._currentReel.easing.loops:0:(null!==this._currentReel&&(t<0&&(t=1/0),this._currentReel.easing.repeat(t),this._currentReel.defaultLoops=t),this)},reelPosition:function(t){if(null===this._currentReel)throw"No active reel.";if(0===arguments.length)return this._currentReel.currentFrame;var e,i=this._currentReel.frames.length;if("end"===t&&(t=i-1),t<1&&t>0)e=t,t=Math.floor(i*e);else{if(t!==Math.floor(t))throw"Position "+t+" is invalid.";t<0&&(t=i-1+t),e=t/i}return t=Math.min(t,i-1),t=Math.max(t,0),this._setProgress(e),this._setFrame(t),this},_animationTick:function(t){var e=this._reels[this._currentReelId];e.easing.tick(t.dt*this.animationSpeed);var i=e.easing.value(),n=Math.min(Math.floor(e.frames.length*i),e.frames.length-1);this._setFrame(n),!0===e.easing.complete&&(this.pauseAnimation(),this.trigger("AnimationEnd",this._currentReel))},_setFrame:function(t){var e=this._currentReel;t!==e.currentFrame&&(e.currentFrame=t,this._updateSprite(),this.trigger("FrameChange",e))},_updateSprite:function(){var t=this._currentReel,e=t.frames[t.currentFrame];this.sprite(e[0],e[1])},_setProgress:function(t,e){this._currentReel.easing.setProgress(t,e)},isPlaying:function(t){return!!this._isPlaying&&(t?this._currentReelId===t:!!this._currentReelId)},getReel:function(t){if(0===arguments.length){if(!this._currentReelId)return null;t=this._currentReelId}return this._reels[t]}})},{"../core/core.js":9}],36:[function(t,e,i){var n=t("../core/core.js");n.defaultShader("Sprite",new n.WebGLShader("attribute vec2 aPosition;\nattribute vec3 aOrientation;\nattribute vec2 aLayer;\nattribute vec2 aTextureCoord;\n\nvarying mediump vec3 vTextureCoord;\n\nuniform vec4 uViewport;\nuniform mediump vec2 uTextureDimensions;\n\nmat4 viewportScale = mat4(2.0 / uViewport.z, 0, 0, 0,    0, -2.0 / uViewport.w, 0,0,    0, 0,1,0,    -1,+1,0,1);\nvec4 viewportTranslation = vec4(uViewport.xy, 0, 0);\n\nvoid main() {\n  vec2 pos = aPosition;\n  vec2 entityOrigin = aOrientation.xy;\n  mat2 entityRotationMatrix = mat2(cos(aOrientation.z), sin(aOrientation.z), -sin(aOrientation.z), cos(aOrientation.z));\n  \n  pos = entityRotationMatrix * (pos - entityOrigin) + entityOrigin ;\n  gl_Position = viewportScale * (viewportTranslation + vec4(pos, 1.0/(1.0+exp(aLayer.x) ), 1) );\n  vTextureCoord = vec3(aTextureCoord, aLayer.y);\n}","varying mediump vec3 vTextureCoord;\n  \nuniform sampler2D uSampler;\nuniform mediump vec2 uTextureDimensions;\n\nvoid main(void) {\n  highp vec2 coord =   vTextureCoord.xy / uTextureDimensions;\n  mediump vec4 base_color = texture2D(uSampler, coord);\n  gl_FragColor = vec4(base_color.rgb*base_color.a*vTextureCoord.z, base_color.a*vTextureCoord.z);\n}",[{name:"aPosition",width:2},{name:"aOrientation",width:3},{name:"aLayer",width:2},{name:"aTextureCoord",width:2}],function(t,e){var i=t.co;t.program.writeVector("aTextureCoord",i.x,i.y,i.x,i.y+i.h,i.x+i.w,i.y,i.x+i.w,i.y+i.h)})),n.extend({sprite:function(t,e,i,r,s,o,a){var h,u,c;"string"==typeof t&&(o=s,s=r,r=e,i=t,t=1,e=1),"string"==typeof e&&(o=s,s=r,r=i,i=e,e=t),!o&&s&&(o=s),s=parseInt(s||0,10),o=parseInt(o||0,10);var l=function(){this.ready=!0,this.trigger("Invalidate")};(c=n.asset(i))||(c=new Image,c.src=i,n.asset(i,c),c.onload=function(){for(var t in r)n(t).each(l)});var d=function(){this.requires("2D, Sprite"),this.__trim=[0,0,0,0],this.__image=i,this.__map=r,this.__coord=[this.__coord[0],this.__coord[1],this.__coord[2],this.__coord[3]],this.__tile=t,this.__tileh=e,this.__padding=[s,o],this.__padBorder=a,this.sprite(this.__coord[0],this.__coord[1],this.__coord[2],this.__coord[3]),this.img=c,this.img.complete&&this.img.width>0&&(this.ready=!0,this.trigger("Invalidate")),this.w=this.__coord[2],this.h=this.__coord[3],this._setupSpriteImage(this._drawLayer)};for(h in r)r.hasOwnProperty(h)&&(u=r[h],n.c(h,{ready:!1,__coord:[u[0],u[1],u[2]||1,u[3]||1],init:d}));return this}}),n.c("Sprite",{__image:"",__tile:0,__tileh:0,__padding:null,__trim:null,img:null,ready:!1,init:function(){this.__trim=[0,0,0,0],this.bind("Draw",this._drawSprite),this.bind("LayerAttached",this._setupSpriteImage)},remove:function(){this.unbind("Draw",this._drawSprite),this.unbind("LayerAttached",this._setupSpriteImage)},_setupSpriteImage:function(t){this.__image&&this.img&&t&&"WebGL"===t.type&&(this._establishShader(this.__image,n.defaultShader("Sprite")),this.program.setTexture(t.makeTexture(this.__image,this.img,!1)))},_drawSprite:function(t){var e=t.co,i=t.pos,n=t.ctx;if("canvas"===t.type)n.drawImage(this.img,e.x,e.y,e.w,e.h,i._x,i._y,i._w,i._h);else if("DOM"===t.type){var r=this._h/e.h,s=this._w/e.w,o=this._element.style,a=o.backgroundColor;"initial"===a&&(a="");var h=a+" url('"+this.__image+"') no-repeat";h!==o.background&&(o.background=h),o.backgroundPosition="-"+e.x*s+"px -"+e.y*r+"px",1===r&&1===s||(o.backgroundSize=this.img.width*s+"px "+this.img.height*r+"px")}else"webgl"===t.type&&t.program.draw(t,this)},sprite:function(t,e,i,n){if("string"==typeof t){var r=this.__map[t];if(!r)return this;t=r[0],e=r[1],i=r[2]||1,n=r[3]||1}return this.__coord=this.__coord||[0,0,0,0],this.__coord[0]=t*(this.__tile+this.__padding[0])+(this.__padBorder?this.__padding[0]:0)+this.__trim[0],this.__coord[1]=e*(this.__tileh+this.__padding[1])+(this.__padBorder?this.__padding[1]:0)+this.__trim[1],void 0!==i&&void 0!==n&&(this.__coord[2]=this.__trim[2]||i*this.__tile||this.__tile,this.__coord[3]=this.__trim[3]||n*this.__tileh||this.__tileh),this.trigger("Invalidate"),this},crop:function(t,e,i,n){var r=this._mbr||this.pos();return this.__trim=[],this.__trim[0]=t,this.__trim[1]=e,this.__trim[2]=i,this.__trim[3]=n,this.__coord[0]+=t,this.__coord[1]+=e,this.__coord[2]=i,this.__coord[3]=n,this._w=i,this._h=n,this.trigger("Invalidate",r),this}})},{"../core/core.js":9}],37:[function(t,e,i){var n=t("../core/core.js");n.c("Text",{_text:"",defaultSize:"10px",defaultFamily:"sans-serif",defaultVariant:"normal",defaultLineHeight:"normal",defaultTextAlign:"left",ready:!0,init:function(){this.requires("2D"),this._textFont={type:"",weight:"",size:this.defaultSize,lineHeight:this.defaultLineHeight,family:this.defaultFamily,variant:this.defaultVariant},this._textAlign=this.defaultTextAlign},events:{Draw:function(t){var e=this._fontString();if("DOM"===t.type){var i=this._element,n=i.style;n.color=this._textColor,n.font=e,n.textAlign=this._textAlign,i.innerHTML=this._text}else if("canvas"===t.type){var r=t.ctx;r.save(),r.textBaseline="top",r.fillStyle=this._textColor||"rgb(0,0,0)",r.font=e,r.textAlign=this._textAlign,r.fillText(this._text,t.pos._x,t.pos._y),r.restore()}}},remove:function(){this.unbind(this._textUpdateEvent,this._dynamicTextUpdate)},_getFontHeight:function(){var t=/([a-zA-Z]+)\b/,e={px:1,pt:4/3,pc:16,cm:96/2.54,mm:96/25.4,in:96,em:void 0,ex:void 0};return function(i){var n=parseFloat(i),r=t.exec(i),s=r?r[1]:"px";return void 0!==e[s]?Math.ceil(n*e[s]):Math.ceil(n)}}(),_textGenerator:null,text:function(t){return void 0===t||null===t?this._text:("function"==typeof t?(this._text=t.call(this),this._textGenerator=t):(this._text=t,this._textGenerator=null),this.has("Canvas")&&this._resizeForCanvas(),this.trigger("Invalidate"),this)},_dynamicTextOn:!1,_textUpdateEvent:null,_dynamicTextUpdate:function(){this._textGenerator&&this.text(this._textGenerator)},dynamicTextGeneration:function(t,e){return this.unbind(this._textUpdateEvent,this._dynamicTextUpdate),t&&(this._textUpdateEvent=e||"EnterFrame",this.bind(this._textUpdateEvent,this._dynamicTextUpdate)),this},_resizeForCanvas:function(){var t=this._drawContext;t.font=this._fontString(),this.w=t.measureText(this._text).width;var e=this._textFont.size||this.defaultSize;this.h=1.1*this._getFontHeight(e),"left"===this._textAlign||"start"===this._textAlign?this.offsetBoundary(0,0,0,0):"center"===this._textAlign?this.offsetBoundary(this.w/2,0,-this.w/2,0):"end"!==this._textAlign&&"right"!==this._textAlign||this.offsetBoundary(this.w,0,-this.w,0)},_fontString:function(){return this._textFont.type+" "+this._textFont.variant+" "+this._textFont.weight+" "+this._textFont.size+" / "+this._textFont.lineHeight+" "+this._textFont.family},textColor:function(t){return n.assignColor(t,this),this._textColor="rgba("+this._red+", "+this._green+", "+this._blue+", "+this._strength+")",this.trigger("Invalidate"),this},textAlign:function(t){return this._textAlign=t,this.has("Canvas")&&this._resizeForCanvas(),this.trigger("Invalidate"),this},textFont:function(t,e){if(1===arguments.length){if("string"==typeof t)return this._textFont[t];if("object"===(void 0===t?"undefined":o(t)))for(var i in t)this._textFont[i]="family"===i?"'"+t[i]+"'":t[i]}else this._textFont[t]=e;return this.has("Canvas")&&this._resizeForCanvas(),this.trigger("Invalidate"),this},unselectable:function(){return this.has("DOM")&&(this.css({"-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",cursor:"default"}),this.trigger("Invalidate")),this}})},{"../core/core.js":9}],38:[function(t,e,i){var n=t("../core/core.js"),r=window.document;n.extend({viewport:{clampToEntities:!0,_width:0,_height:0,_x:0,_y:0,_scale:1,bounds:null,scroll:function(t,e){this[t]=e,n.trigger("ViewportScroll"),n.trigger("InvalidateViewport")},rect_object:{_x:0,_y:0,_w:0,_h:0},rect:function(t){return t=t||this.rect_object,t._x=-this._x,t._y=-this._y,t._w=this._width/this._scale,t._h=this._height/this._scale,t},pan:function(){function t(t){a.tick(t.dt);var h=a.value();n.viewport.x=(1-h)*s+h*i,n.viewport.y=(1-h)*o+h*r,n.viewport._clamp(),a.complete&&(e(),n.trigger("CameraAnimationDone"))}function e(){n.unbind("EnterFrame",t)}var i,r,s,o,a;return n._preBind("StopCamera",e),function(e,h,u,c){n.trigger("StopCamera"),"reset"!==e&&(s=n.viewport._x,o=n.viewport._y,i=s-e,r=o-h,a=new n.easing(u,c),n.uniqueBind("EnterFrame",t))}}(),follow:function(){function t(){var t=n.viewport._scale;n.viewport.scroll("_x",-(this.x+this.w/2-n.viewport.width/2/t-r*t)),n.viewport.scroll("_y",-(this.y+this.h/2-n.viewport.height/2/t-s*t)),n.viewport._clamp()}function e(){i&&(i.unbind("Move",t),i.unbind("ViewportScale",t),i.unbind("ViewportResize",t))}var i,r,s;return n._preBind("StopCamera",e),function(e,o,a){e&&e.has("2D")&&(n.trigger("StopCamera"),i=e,r=void 0!==o?o:0,s=void 0!==a?a:0,e.bind("Move",t),e.bind("ViewportScale",t),e.bind("ViewportResize",t),t.call(e))}}(),centerOn:function(t,e){var i=t.x+n.viewport.x,r=t.y+n.viewport.y,s=t.w/2,o=t.h/2,a=n.viewport.width/2/n.viewport._scale,h=n.viewport.height/2/n.viewport._scale,u=i+s-a,c=r+o-h;n.viewport.pan(u,c,e)},zoom:function(){function t(){n.unbind("EnterFrame",e)}function e(e){var r,l;c.tick(e.dt),r=Math.pow(s,c.value()),l=1===s?c.value():(1/r-1)/(1/s-1),n.viewport.scale(r*i),n.viewport.scroll("_x",o*(1-l)+a*l),n.viewport.scroll("_y",h*(1-l)+u*l),n.viewport._clamp(),c.complete&&(t(),n.trigger("CameraAnimationDone"))}n._preBind("StopCamera",t);var i,r,s,o,a,h,u,c;return function(t,l,d,_,p){if(!t)return void n.viewport.scale(1);arguments.length<=2&&(_=l,l=n.viewport.x-n.viewport.width,d=n.viewport.y-n.viewport.height),n.trigger("StopCamera"),i=n.viewport._scale,s=t,r=i*s,o=n.viewport.x,h=n.viewport.y,a=-(l-n.viewport.width/(2*r)),u=-(d-n.viewport.height/(2*r)),c=new n.easing(_,p),n.uniqueBind("EnterFrame",e)}}(),scale:function(){return function(t){this._scale=t||1,n.trigger("InvalidateViewport"),n.trigger("ViewportScale")}}(),mouselook:function(){var t=!1,e=!1,i={};return function(r,s){if("boolean"==typeof r)return t=r,void(t?n.mouseObjs++:n.mouseObjs=Math.max(0,n.mouseObjs-1));if(t)switch(r){case"move":case"drag":if(!e)return;var o={x:s.clientX-i.x,y:s.clientY-i.y};i.x=s.clientX,i.y=s.clientY,n.viewport.x+=o.x,n.viewport.y+=o.y,n.viewport._clamp();break;case"start":n.trigger("StopCamera"),i.x=s.clientX,i.y=s.clientY,e=!0;break;case"stop":e=!1}}}(),_clamp:function(){if(this.clampToEntities){var t=n.clone(this.bounds)||n.clone(n.map.boundaries());t.max.x*=this._scale,t.min.x*=this._scale,t.max.y*=this._scale,t.min.y*=this._scale,t.max.x-t.min.x>n.viewport.width?n.viewport.x<(-t.max.x+n.viewport.width)/this._scale?n.viewport.x=(-t.max.x+n.viewport.width)/this._scale:n.viewport.x>-t.min.x&&(n.viewport.x=-t.min.x):n.viewport.x=-1*(t.min.x+(t.max.x-t.min.x)/2-n.viewport.width/2),t.max.y-t.min.y>n.viewport.height?n.viewport.y<(-t.max.y+n.viewport.height)/this._scale?n.viewport.y=(-t.max.y+n.viewport.height)/this._scale:n.viewport.y>-t.min.y&&(n.viewport.y=-t.min.y):n.viewport.y=-1*(t.min.y+(t.max.y-t.min.y)/2-n.viewport.height/2)}},init:function(t,e,i){n.createLayer("DefaultCanvasLayer","Canvas",{z:20}),n.createLayer("DefaultDOMLayer","DOM",{z:30}),n.createLayer("DefaultWebGLLayer","WebGL",{z:10}),this._defineViewportProperties(),this._x=0,this._y=0,this._scale=1,this.bounds=null,this._width=t||window.innerWidth,this._height=e||window.innerHeight,void 0===i&&(i="cr-stage");var s;if("string"==typeof i)s=r.getElementById(i);else{if(!("undefined"!=typeof HTMLElement?i instanceof HTMLElement:i instanceof Element))throw new TypeError("stage_elem must be a string or an HTMLElement");s=i}n.stage={x:0,y:0,fullscreen:!1,elem:s||r.createElement("div")},t||e||(r.body.style.overflow="hidden",n.stage.fullscreen=!0),n.addEvent(this,window,"resize",n.viewport.reload),n.addEvent(this,window,"blur",function(){n.settings.get("autoPause")&&(n._paused||n.pause())}),n.addEvent(this,window,"focus",function(){n._paused&&n.settings.get("autoPause")&&n.pause()}),n.settings.register("stageSelectable",function(t){n.stage.elem.onselectstart=t?function(){return!0}:function(){return!1}}),n.settings.modify("stageSelectable",!1),n.settings.register("stageContextMenu",function(t){n.stage.elem.oncontextmenu=t?function(){return!0}:function(){return!1}}),n.settings.modify("stageContextMenu",!1),n.settings.register("autoPause",function(){}),n.settings.modify("autoPause",!1),s||(r.body.appendChild(n.stage.elem),n.stage.elem.id=i);var a,h=n.stage.elem.style;if(h.width=this.width+"px",h.height=this.height+"px",h.overflow="hidden",n.bind("ViewportResize",function(){n.trigger("InvalidateViewport")}),n.mobile){void 0!==o(h.webkitTapHighlightColor)&&(h.webkitTapHighlightColor="rgba(0,0,0,0)");var u=r.createElement("meta"),c=r.getElementsByTagName("head")[0];u=r.createElement("meta"),u.setAttribute("name","apple-mobile-web-app-capable"),u.setAttribute("content","yes"),c.appendChild(u),n.addEvent(this,n.stage.elem,"touchmove",function(t){t.preventDefault()})}h.position="relative",a=n.domHelper.innerPosition(n.stage.elem),n.stage.x=a.x,n.stage.y=a.y,n.uniqueBind("ViewportResize",this._resize)},_resize:function(){n.stage.elem.style.width=n.viewport.width+"px",n.stage.elem.style.height=n.viewport.height+"px"},_defineViewportProperties:function(){Object.defineProperty(this,"x",{set:function(t){this.scroll("_x",t)},get:function(){return this._x},configurable:!0}),Object.defineProperty(this,"y",{set:function(t){this.scroll("_y",t)},get:function(){return this._y},configurable:!0}),Object.defineProperty(this,"width",{set:function(t){this._width=t,n.trigger("ViewportResize")},get:function(){return this._width},configurable:!0}),Object.defineProperty(this,"height",{set:function(t){this._height=t,n.trigger("ViewportResize")},get:function(){return this._height},configurable:!0})},reload:function(){var t,e=window.innerWidth,i=window.innerHeight;n.stage.fullscreen&&(this._width=e,this._height=i,n.trigger("ViewportResize")),t=n.domHelper.innerPosition(n.stage.elem),n.stage.x=t.x,n.stage.y=t.y},reset:function(){n.viewport.mouselook("stop"),n.trigger("StopCamera"),n.viewport.scroll("_x",0),n.viewport.scroll("_y",0),n.viewport.scale(1)},onScreen:function(t){return n.viewport._x+t._x+t._w>0&&n.viewport._y+t._y+t._h>0&&n.viewport._x+t._x<n.viewport.width&&n.viewport._y+t._y<n.viewport.height}}})},{"../core/core.js":9}],39:[function(t,e,i){function n(t,e){this.shader=e,this.layer=t,this.context=t.context,this.draw=function(){},this.array_size=16,this.max_size=1024,this._indexArray=new Uint16Array(6*this.array_size),this._indexBuffer=t.context.createBuffer()}var r=t("../core/core.js"),s=window.document;n.prototype={initAttributes:function(t){this.attributes=t,this._attribute_table={};for(var e=0,i=0;i<t.length;i++){var n=t[i];this._attribute_table[n.name]=n,n.bytes=n.bytes||Float32Array.BYTES_PER_ELEMENT,n.type=n.type||this.context.FLOAT,n.offset=e,n.location=this.context.getAttribLocation(this.shader,n.name),this.context.enableVertexAttribArray(n.location),e+=n.width}this.stride=e,this._attributeArray=new Float32Array(4*this.array_size*this.stride),this._attributeBuffer=this.context.createBuffer(),this._registryHoles=[],this._registrySize=0},growArrays:function(t){if(!(this.array_size>=this.max_size)){var e=Math.min(t,this.max_size),i=new Float32Array(4*e*this.stride),n=new Uint16Array(6*e);i.set(this._attributeArray),n.set(this._indexArray),this._attributeArray=i,this._indexArray=n,this.array_size=e}},registerEntity:function(t){if(0===this._registryHoles.length){if(this._registrySize>=this.max_size)throw"Number of entities exceeds maximum limit.";this._registrySize>=this.array_size&&this.growArrays(2*this.array_size),t._glBufferIndex=this._registrySize,this._registrySize++}else t._glBufferIndex=this._registryHoles.pop()},unregisterEntity:function(t){"number"==typeof t._glBufferIndex&&this._registryHoles.push(t._glBufferIndex),t._glBufferIndex=null},resetRegistry:function(){this._maxElement=0,this._registryHoles.length=0},setCurrentEntity:function(t){this.ent_offset=4*t._glBufferIndex,this.ent=t},switchTo:function(){var t=this.context;t.useProgram(this.shader),t.bindBuffer(t.ARRAY_BUFFER,this._attributeBuffer);for(var e,i=this.attributes,n=0;n<i.length;n++)e=i[n],t.vertexAttribPointer(e.location,e.width,e.type,!1,this.stride*e.bytes,e.offset*e.bytes);var r=this.texture_obj;r&&null===r.unit&&this.layer.texture_manager.bindTexture(r),this.index_pointer=0},setTexture:function(t){void 0===this.texture_obj&&(t.setToProgram(this.shader,"uSampler","uTextureDimensions"),this.texture_obj=t)},addIndices:function(t){var e=this._indexArray,i=this.index_pointer;e[0+i]=0+t,e[1+i]=1+t,e[2+i]=2+t,e[3+i]=1+t,e[4+i]=2+t,e[5+i]=3+t,this.index_pointer+=6},renderBatch:function(){var t=this.context;t.bindBuffer(t.ARRAY_BUFFER,this._attributeBuffer),t.bufferData(t.ARRAY_BUFFER,this._attributeArray,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this._indexArray,t.STATIC_DRAW),t.drawElements(t.TRIANGLES,this.index_pointer,t.UNSIGNED_SHORT,0)},setViewportUniforms:function(t,e){var i=this.context;i.useProgram(this.shader),i.uniform4f(this.shader.viewport,-t._x,-t._y,t._w,t._h)},writeVector:function(t,e,i){for(var n=this._attribute_table[t],r=this.stride,s=n.offset+this.ent_offset*r,o=n.width,a=arguments.length-1,h=this._attributeArray,u=0;u<4;u++)for(var c=0;c<o;c++)h[s+r*u+c]=arguments[(o*u+c)%a+1]}},r._registerLayerTemplate("WebGL",{type:"WebGL",options:{xResponse:1,yResponse:1,scaleResponse:1,z:0},context:null,changed_objects:[],_compileShader:function(t,e){var i=this.context,n=i.createShader(e);if(i.shaderSource(n,t),i.compileShader(n),!i.getShaderParameter(n,i.COMPILE_STATUS))throw i.getShaderInfoLog(n);return n},_makeProgram:function(t){var e=this.context,i=this._compileShader(t.fragmentCode,e.FRAGMENT_SHADER),n=this._compileShader(t.vertexCode,e.VERTEX_SHADER),r=e.createProgram();if(e.attachShader(r,n),e.attachShader(r,i),e.linkProgram(r),!e.getProgramParameter(r,e.LINK_STATUS))throw"Could not initialise shaders";return r.viewport=e.getUniformLocation(r,"uViewport"),r},getProgramWrapper:function(t,e){if(void 0===this.programs[t]){var i=this._makeProgram(e),r=new n(this,i);r.name=t,r.initAttributes(e.attributeList),r.draw=e.drawCallback,r.setViewportUniforms(this._viewportRect(),this.options),this.programs[t]=r}return this.programs[t]},makeTexture:function(t,e,i){return this.texture_manager.makeTexture(t,e,i)},init:function(){if(!r.support.webgl)return r.trigger("NoWebGL"),void r.stop();this.changed_objects=[],this.programs={};var t;t=s.createElement("canvas"),t.width=r.viewport.width,t.height=r.viewport.height,t.style.position="absolute",t.style.left="0px",t.style.top="0px",t.style.zIndex=this.options.z,r.stage.elem.appendChild(t);var e;try{e=t.getContext("webgl",{premultipliedalpha:!0})||t.getContext("experimental-webgl",{premultipliedalpha:!0}),e.viewportWidth=t.width,e.viewportHeight=t.height}catch(t){return r.trigger("NoWebGL"),void r.stop()}this.context=e,this._canvas=t,e.clearColor(0,0,0,0),e.disable(e.DEPTH_TEST),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),e.enable(e.BLEND),this.uniqueBind("RenderScene",this.render),this.uniqueBind("ViewportResize",this._resize),this.uniqueBind("InvalidateViewport",function(){this.dirtyViewport=!0}),this.uniqueBind("PixelartSet",this._setPixelart),this._setPixelart(r._pixelartEnabled),this.dirtyViewport=!0,this.texture_manager=new r.TextureManager(e,this),r._addDrawLayerInstance(this)},remove:function(){this._canvas.parentNode.removeChild(this._canvas),r._removeDrawLayerInstance(this)},_resize:function(){var t=this._canvas;t.width=r.viewport.width,t.height=r.viewport.height;var e=this.context;e.viewportWidth=t.width,e.viewportHeight=t.height},_setPixelart:function(t){var e=this.context;this.texture_filter=t?e.NEAREST:e.LINEAR},zsort:function(t,e){return t._globalZ-e._globalZ},visible_gl:[],render:function(t){t=t||this._viewportRect();var e=this.context;e.viewport(0,0,e.viewportWidth,e.viewportHeight),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);var i=this.programs;if(this.dirtyViewport){var n=this._viewportRect();for(var s in i)i[s].setViewportUniforms(n,this.options);this.dirtyViewport=!1}var o,a=r.map.search(t),h=0,u=a.length,c=this.visible_gl;for(c.length=0,h=0;h<u;h++)o=a[h],o._visible&&o.program&&o._drawLayer===this&&c.push(o);c.sort(this.zsort),u=c.length;var l=null;for(h=0;h<u;h++)o=c[h],l!==o.program&&(null!==l&&l.renderBatch(),l=o.program,l.index_pointer=0,l.switchTo()),o.draw(),o._changed=!1;null!==l&&l.renderBatch()},dirty:function(t){},attach:function(t){t._drawContext=this.context},detach:function(t){t.program&&t.program.unregisterEntity(t)}})},{"../core/core.js":9}],40:[function(t,e,i){var n=t("../core/core.js");n.extend({WebGLShader:function(t,e,i,n){this.vertexCode=t,this.fragmentCode=e,this.attributeList=i,this.drawCallback=n},defaultShader:function(t,e){if(this._defaultShaders=this._defaultShaders||{},1===arguments.length)return this._defaultShaders[t];this._defaultShaders[t]=e}}),n.c("WebGL",{init:function(){this.requires("Renderable"),this._customLayer||this._attachToLayer(n.s("DefaultWebGLLayer"))},remove:function(){this._detachFromLayer()},drawVars:{type:"webgl",pos:{},ctx:null,coord:[0,0,0,0],co:{x:0,y:0,w:0,h:0}},draw:function(t,e,i,n,r){if(this.ready){4===arguments.length&&(r=n,n=i,i=e,e=t,t=this._drawLayer.context);var s=this.drawVars.pos;s._x=this._x+(e||0),s._y=this._y+(i||0),s._w=n||this._w,s._h=r||this._h;var o=this.__coord||[0,0,0,0],a=this.drawVars.co;a.x=o[0]+(e||0),a.y=o[1]+(i||0),a.w=n||o[2],a.h=r||o[3],this._flipX&&(a.x=a.x+a.w,a.w=-a.w),this._flipY&&(a.y=a.y+a.h,a.h=-a.h);var h=this._drawContext;this.drawVars.gl=h;var u=this.drawVars.program=this.program;return u.setCurrentEntity(this),u.writeVector("aPosition",this._x,this._y,this._x,this._y+this._h,this._x+this._w,this._y,this._x+this._w,this._y+this._h),u.writeVector("aOrientation",this._origin.x+this._x,this._origin.y+this._y,this._rotation*Math.PI/180),u.writeVector("aLayer",this._globalZ,this._alpha),this.trigger("Draw",this.drawVars),u.addIndices(u.ent_offset),this}},_establishShader:function(t,e){this.program=this._drawLayer.getProgramWrapper(t,e),this.program.registerEntity(this),this.ready=!0}})},{"../core/core.js":9}],41:[function(t,e,i){var n=t("../core/core.js");n.extend({diamondIso:{_tile:{width:0,height:0},getTileDimensions:function(){return{w:this._tile.width,h:this._tile.height}},_map:{width:0,height:0},_origin:{x:0,y:0},_tiles:[],getTile:function(t,e,i){return this._tiles[t][e][i]},init:function(t,e,i,n,r,s){this._tile.width=parseInt(t,10),this._tile.height=parseInt(e,10)||parseInt(t,10)/2,this._tile.r=this._tile.width/this._tile.height,this._map.width=parseInt(i,10),this._map.height=parseInt(n,10)||parseInt(i,10);for(var o=0;o<i;o++){this._tiles[o]=Array();for(var a=0;a<n;a++)this._tiles[o][a]=Array()}return this.x=parseInt(r,10)||0,this.y=parseInt(s,10)||0,this.layerZLevel=i+n+1,this},place:function(t,e,i,n){var r=this.pos2px(e,i),s=t.h/this._tile.height;t.x=r.x,t.y=r.y-(s-2)*this._tile.height-this._tile.height*n,t.z=this.getZAtLoc(e,i,n);for(var o=0;o<=s-2;o++){var a=this._tiles[e][i][n+o];a&&a!==t&&a.destroy(),this._tiles[e][i][n+o]=t}return this},detachTile:function(t){for(var e=0;e<this._map.width;e++)for(var i=0;i<this._map.height;i++)for(var n=this._tiles[e][i].length,r=0;r<n;r++)if(this._tiles[e][i][r]&&t===this._tiles[e][i][r]){for(var s=t.h/this._tile.height,o=0;o<s;o++)this._tiles[e][i][r+o]=void 0;return{x:e,y:i,z:r}}return!1},centerAt:function(t,e){var i=this.pos2px(t,e);n.viewport.x=-i.x+n.viewport.width/2-this._tile.width,n.viewport.y=-i.y+n.viewport.height/2},getZAtLoc:function(t,e,i){return this.layerZLevel*i+t+e},pos2px:function(t,e){return{x:this.x+(t-e-1)*this._tile.width/2,y:this.y+(t+e)*this._tile.height/2}},px2pos:function(t,e){var i=(e-this.y)/this._tile.height,n=(t-this.x)/this._tile.width,r=i+n,s=i-n,o=r>0&&r<this._map.width,a=s>0&&s<this._map.height;if(o&&a)return{x:~~r,y:~~s}},getOverlappingTiles:function(t,e){var i=this.px2pos(t,e),n=[],r=~~i.x,s=~~i.y,o=this._map.width-r,a=this._map.height-s,h=Math.min(o,a),u=this._tiles[r][s][1];u&&n.push(u);for(var c=1;c<h;c++){var l=this._tiles[r+c][s+c][c];l&&n.push(l)}return n},polygon:function(t){t.requires("Collision");var e=[0,t.h-0-this._tile.height/2,0-this._tile.width/2,t.h-0-0,0-this._tile.width,t.h-0-this._tile.height/2,0-this._tile.width/2,t.h-0-this._tile.height];return new n.polygon(e)}}})},{"../core/core.js":9}],42:[function(t,e,i){var n=t("../core/core.js");n.extend({isometric:{_tile:{width:0,height:0},_elements:{},_pos:{x:0,y:0},_z:0,size:function(t,e){return this._tile.width=t,this._tile.height=e>0?e:t/2,this},place:function(t,e,i,r){var s=this.pos2px(t,e);return s.top-=i*(this._tile.height/2),r.x=s.left+n.viewport._x,r.y=s.top+n.viewport._y,r.z+=i,this},pos2px:function(t,e){return{left:t*this._tile.width+(1&e)*(this._tile.width/2),top:e*this._tile.height/2}},px2pos:function(t,e){return{x:-Math.ceil(-t/this._tile.width-.5*(1&e)),y:e/this._tile.height*2}},centerAt:function(t,e){if("number"==typeof t&&"number"==typeof e){var i=this.pos2px(t,e);return n.viewport._x=-i.left+n.viewport.width/2-this._tile.width/2,n.viewport._y=-i.top+n.viewport.height/2-this._tile.height/2,this}return{top:-n.viewport._y+n.viewport.height/2-this._tile.height/2,left:-n.viewport._x+n.viewport.width/2-this._tile.width/2}},area:function(){var t=this.centerAt(),e=this.px2pos(-t.left+n.viewport.width/2,-t.top+n.viewport.height/2),i=this.px2pos(-t.left-n.viewport.width/2,-t.top-n.viewport.height/2);return{x:{start:e.x,end:i.x},y:{start:e.y,end:i.y}}}}})},{"../core/core.js":9}],43:[function(t,e,i){var n=t("../core/core.js"),r=window.document;n.extend({audio:{sounds:{},supported:null,codecs:{ogg:'audio/ogg; codecs="vorbis"',wav:'audio/wav; codecs="1"',webma:'audio/webm; codecs="vorbis"',mp3:'audio/mpeg; codecs="mp3"',m4a:'audio/mp4; codecs="mp4a.40.2"'},volume:1,muted:!1,paused:!1,playCheck:null,_canPlay:function(){if(this.supported={},n.support.audio){var t,e=this.audioElement();for(var i in this.codecs)t=e.canPlayType(this.codecs[i]),this.supported[i]=""!==t&&"no"!==t}},supports:function(t){return null===this.supported&&this._canPlay(),!!this.supported[t]},audioElement:function(){return"undefined"!=typeof Audio?new Audio(""):r.createElement("audio")},create:function(t,e){var i=e.substr(e.lastIndexOf(".")+1).toLowerCase();if(!this.supports(i))return!1;var r=this.audioElement();return r.id=t,r.preload="auto",r.volume=n.audio.volume,r.src=e,n.asset(e,r),this.sounds[t]={obj:r,played:0,volume:n.audio.volume},this.sounds[t]},add:function(t,e){if(n.support.audio){var i,r;if(1===arguments.length&&"object"===(void 0===t?"undefined":o(t)))for(var s in t)for(i in t[s])if(r=n.audio.create(s,t[s][i]))break;if("string"==typeof t&&("string"==typeof e&&(r=n.audio.create(t,e)),"object"===(void 0===e?"undefined":o(e))))for(i in e)if(r=n.audio.create(t,e[i]))break;return r}},play:function(t,e,i){if(0!==e&&n.support.audio&&this.sounds[t]){var r=this.sounds[t],s=this.getOpenChannel();if(!s)return null;s.id=t,s.repeat=e;var o=s.obj;return s.volume=r.volume=r.obj.volume=i||n.audio.volume,o.volume=r.volume,o.src=r.obj.src,this.muted&&(o.volume=0),o.play(),r.played++,s.onEnd=function(){r.played<s.repeat||-1===s.repeat?(this.currentTime&&(this.currentTime=0),this.play(),r.played++):(s.active=!1,this.pause(),this.removeEventListener("ended",s.onEnd,!0),this.currentTime=0,n.trigger("SoundComplete",{id:s.id}))},o.addEventListener("ended",s.onEnd,!0),o}},maxChannels:7,setChannels:function(t){this.maxChannels=t,t<this.channels.length&&(this.channels.length=t)},channels:[],getOpenChannel:function(){for(var t=0;t<this.channels.length;t++){var e=this.channels[t];if(!1===e.active||e.obj.ended&&e.repeat<=this.sounds[e.id].played)return e.active=!0,e}if(t<this.maxChannels){var i={obj:this.audioElement(),active:!0,_is:function(t){return this.id===t&&this.active}};return this.channels.push(i),i}return null},remove:function(t){if(n.support.audio){var e,i,r=n.paths().audio;if(t)this.sounds[t]&&(e=this.sounds[t],i=e.obj.src.split("/").pop(),n.audio.stop(t),delete n.assets[r+i],delete n.assets[e.obj.src],delete n.audio.sounds[t]);else for(var s in this.sounds)e=this.sounds[s],i=e.obj.src.split("/").pop(),n.audio.stop(t),delete n.assets[r+i],delete n.assets[e.obj.src],delete n.audio.sounds[t]}},stop:function(t){if(n.support.audio){var e;for(var i in this.channels)e=this.channels[i],(!t&&e.active||e._is(t))&&(e.active=!1,e.obj.pause())}},_mute:function(t){if(n.support.audio){var e;for(var i in this.channels)e=this.channels[i],e.obj.volume=t?0:e.volume;this.muted=t}},toggleMute:function(){this.muted?this._mute(!1):this._mute(!0)},mute:function(){this._mute(!0)},unmute:function(){this._mute(!1)},pause:function(t){if(n.support.audio&&t&&this.sounds[t]){var e;for(var i in this.channels)e=this.channels[i],e._is(t)&&!e.obj.paused&&e.obj.pause()}},unpause:function(t){if(n.support.audio&&t&&this.sounds[t]){var e;for(var i in this.channels)e=this.channels[i],e._is(t)&&e.obj.paused&&e.obj.play()}},togglePause:function(t){if(n.support.audio&&t&&this.sounds[t]){var e;for(var i in this.channels)e=this.channels[i],e._is(t)&&(e.obj.paused?e.obj.play():e.obj.pause())}},isPlaying:function(t){if(!n.support.audio)return!1;for(var e in this.channels)if(this.channels[e]._is(t))return!0;return!1}}})},{"../core/core.js":9}],44:[function(t,e,i){var n=t("../core/core.js"),r=t("./spatial-grid.js");n.map=new r;var s=Math,a=s.PI,h=a/180;n.c("2D",{_x:0,_y:0,_w:0,_h:0,_z:0,_globalZ:null,_rotation:0,_origin:null,_mbr:null,_entry:null,_children:null,_parent:null,_2D_property_definitions:{x:{set:function(t){this._setter2d("_x",t)},get:function(){return this._x},configurable:!0,enumerable:!0},_x:{enumerable:!1},y:{set:function(t){this._setter2d("_y",t)},get:function(){return this._y},configurable:!0,enumerable:!0},_y:{enumerable:!1},w:{set:function(t){this._setter2d("_w",t)},get:function(){return this._w},configurable:!0,enumerable:!0},_w:{enumerable:!1},h:{set:function(t){this._setter2d("_h",t)},get:function(){return this._h},configurable:!0,enumerable:!0},_h:{enumerable:!1},z:{set:function(t){this._setter2d("_z",t)},get:function(){return this._z},configurable:!0,enumerable:!0},_z:{enumerable:!1},rotation:{set:function(t){this._setter2d("_rotation",t)},get:function(){return this._rotation},configurable:!0,enumerable:!0},_rotation:{enumerable:!1}},_define2DProperties:function(){for(var t in this._2D_property_definitions)Object.defineProperty(this,t,this._2D_property_definitions[t])},init:function(){this._globalZ=this[0],this._origin={x:0,y:0},this._bx1=0,this._bx2=0,this._by1=0,this._by2=0,this._children=[],this._define2DProperties(),this._entry=n.map.insert(this),this.bind("Move",function(t){var e=this._cbr||this._mbr||this;this._entry.update(e),this._children.length>0&&this._cascade(t)}),this.bind("Rotate",function(t){var e=this._cbr||this._mbr||this;this._entry.update(e),this._children.length>0&&this._cascade(t)}),this.bind("Remove",function(){if(this._children){for(var t=0;t<this._children.length;t++)delete this._children[t]._parent,this._children[t].destroy&&this._children[t].destroy();this._children=[]}this._parent&&this._parent.detach(this),n.map.remove(this._entry),this.detach()})},offsetBoundary:function(t,e,i,n){return 1===arguments.length&&(e=i=n=t),this._bx1=t,this._bx2=i,this._by1=e,this._by2=n,this.trigger("BoundaryOffset"),this._calculateMBR(),this},_calculateMBR:function(){var t=this._origin.x+this._x,e=this._origin.y+this._y,i=-this._rotation*h,n=this._x-this._bx1-t,r=this._x+this._w+this._bx2-t,s=this._y-this._by1-e,o=this._y+this._h+this._by2-e,a=Math.cos(i),u=Math.sin(i);a=a<1e-10&&a>-1e-10?0:a,u=u<1e-10&&u>-1e-10?0:u;var c=n*a+s*u,l=-n*u+s*a,d=r*a+s*u,_=-r*u+s*a,p=r*a+o*u,f=-r*u+o*a,g=n*a+o*u,m=-n*u+o*a,v=Math.floor(Math.min(c,d,p,g)+t),y=Math.floor(Math.min(l,_,f,m)+e),w=Math.ceil(Math.max(c,d,p,g)+t),x=Math.ceil(Math.max(l,_,f,m)+e);if(this._mbr?(this._mbr._x=v,this._mbr._y=y,this._mbr._w=w-v,this._mbr._h=x-y):this._mbr={_x:v,_y:y,_w:w-v,_h:x-y},this._cbr){var b=this._cbr,D=b.cx,C=b.cy,T=b.r,R=t+(D+this._x-t)*a+(C+this._y-e)*u,M=e-(D+this._x-t)*u+(C+this._y-e)*a;b._x=Math.min(R-T,v),b._y=Math.min(M-T,y),b._w=Math.max(R+T,w)-b._x,b._h=Math.max(M+T,x)-b._y}},_rotate:function(t){var e=this._rotation-t;if(0!==e){this._rotation=t;var i={x:this._origin.x+this._x,y:this._origin.y+this._y};this._calculateMBR();var n=e*h,r=Math.cos(n),s=Math.sin(n);this.trigger("Rotate",{cos:-1e-10<r&&r<1e-10?0:r,sin:-1e-10<s&&s<1e-10?0:s,deg:e,rad:n,o:i})}},area:function(){return this._w*this._h},intersect:function(t,e,i,n){var r,s=this._mbr||this;return r="object"===(void 0===t?"undefined":o(t))?t:{_x:t,_y:e,_w:i,_h:n},s._x<r._x+r._w&&s._x+s._w>r._x&&s._y<r._y+r._h&&s._y+s._h>r._y},within:function(t,e,i,n){var r,s=this._mbr||this;return r="object"===(void 0===t?"undefined":o(t))?t:{_x:t,_y:e,_w:i,_h:n},r._x<=s._x&&r._x+r._w>=s._x+s._w&&r._y<=s._y&&r._y+r._h>=s._y+s._h},contains:function(t,e,i,n){var r,s=this._mbr||this;return r="object"===(void 0===t?"undefined":o(t))?t:{_x:t,_y:e,_w:i,_h:n},r._x>=s._x&&r._x+r._w<=s._x+s._w&&r._y>=s._y&&r._y+r._h<=s._y+s._h},pos:function(t){return t=t||{},t._x=this._x,t._y=this._y,t._w=this._w,t._h=this._h,t},mbr:function(t){return t=t||{},this._mbr?(t._x=this._mbr._x,t._y=this._mbr._y,t._w=this._mbr._w,t._h=this._mbr._h,t):this.pos(t)},isAt:function(t,e){if(this.mapArea)return this.mapArea.containsPoint(t,e);if(this.map)return this.map.containsPoint(t,e);var i=this._mbr||this;return i._x<=t&&i._x+i._w>=t&&i._y<=e&&i._y+i._h>=e},move:function(t,e){return"n"===t.charAt(0)&&(this.y-=e),"s"===t.charAt(0)&&(this.y+=e),"e"!==t&&"e"!==t.charAt(1)||(this.x+=e),"w"!==t&&"w"!==t.charAt(1)||(this.x-=e),this},shift:function(t,e,i,n){return t&&(this.x+=t),e&&(this.y+=e),i&&(this.w+=i),n&&(this.h+=n),this},_cascade:function(t){if(t){var e,i=0,n=this._children,r=n.length;if("cos"in t||"sin"in t)for(;i<r;++i)"rotate"in(e=n[i])&&e.rotate(t);else for(var s=this._x-t._x,o=this._y-t._y,a=this._w-t._w,h=this._h-t._h;i<r;++i)e=n[i],e.shift(s,o,a,h)}},attach:function(){for(var t,e=0,i=arguments,n=arguments.length;e<n;++e)t=i[e],t._parent&&t._parent.detach(t),t._parent=this,this._children.push(t);return this},detach:function(t){var e;if(!t){for(e=0;e<this._children.length;e++)this._children[e]._parent=null;return this._children=[],this}for(e=0;e<this._children.length;e++)this._children[e]===t&&this._children.splice(e,1);return t._parent=null,this},origin:function(t,e){if("string"==typeof t)if("centre"===t||"center"===t||-1===t.indexOf(" "))t=this._w/2,e=this._h/2;else{var i=t.split(" ");"top"===i[0]?e=0:"bottom"===i[0]?e=this._h:"middle"!==i[0]&&"center"!==i[1]&&"centre"!==i[1]||(e=this._h/2),"center"===i[1]||"centre"===i[1]||"middle"===i[1]?t=this._w/2:"left"===i[1]?t=0:"right"===i[1]&&(t=this._w)}return this._origin.x=t,this._origin.y=e,this},rotate:function(t){var e,i;e=(this._x+this._origin.x-t.o.x)*t.cos+(this._y+this._origin.y-t.o.y)*t.sin+(t.o.x-this._origin.x),i=(this._y+this._origin.y-t.o.y)*t.cos-(this._x+this._origin.x-t.o.x)*t.sin+(t.o.y-this._origin.y),this._setter2d("_rotation",this._rotation-t.deg),this._setter2d("_x",e),this._setter2d("_y",i)},_setter2d:function(t,e){if(this[t]!==e){var i,r=n.rectManager._pool.copy(this);if("_rotation"===t)this._rotate(e);else if("_x"===t||"_y"===t)i=this._mbr,i&&(i[t]-=this[t]-e,this._cbr&&(this._cbr[t]-=this[t]-e)),this[t]=e,this.trigger("Move",r);else if("_h"===t||"_w"===t){i=this._mbr;var s=this[t];this[t]=e,i&&this._calculateMBR(),"_w"===t?this.trigger("Resize",{axis:"w",amount:e-s}):"_h"===t&&this.trigger("Resize",{axis:"h",amount:e-s}),this.trigger("Move",r)}else if("_z"===t){var o=e<<0;e=e===o?o:o+1,this._globalZ=1e5*e+this[0],this[t]=e,this.trigger("Reorder")}this[t]=e,this.trigger("Invalidate"),n.rectManager._pool.recycle(r)}}}),n.polygon=function(t){arguments.length>1&&(t=Array.prototype.slice.call(arguments,0)),this.points=t},n.polygon.prototype={containsPoint:function(t,e){var i,n,r=this.points,s=r.length/2,o=!1;for(i=0,n=s-1;i<s;n=i++)r[2*i+1]>e!=r[2*n+1]>e&&t<(r[2*n]-r[2*i])*(e-r[2*i+1])/(r[2*n+1]-r[2*i+1])+r[2*i]&&(o=!o);return o},shift:function(t,e){for(var i=0,n=this.points,r=n.length;i<r;i+=2)n[i]+=t,n[i+1]+=e},clone:function(){return new n.polygon(this.points.slice(0))},rotate:function(t){for(var e,i,n=0,r=this.points,s=r.length;n<s;n+=2)e=t.o.x+(r[n]-t.o.x)*t.cos+(r[n+1]-t.o.y)*t.sin,i=t.o.y-(r[n]-t.o.x)*t.sin+(r[n+1]-t.o.y)*t.cos,r[n]=e,r[n+1]=i},intersectRay:function(t,e){for(var i,n,r,s,o,a,h,u,c,l=this.points,d=1/0,_=t._x,p=e.x,f=t._y,g=e.y,m=0,v=l.length,y=l[v-2],w=l[v-1];m<v;m+=2)a=l[m],u=l[m+1],h=a-y,c=u-w,n=(y-_)*c-(w-f)*h,s=(y-_)*g-(w-f)*p,o=p*c-g*h,0!==o?(i=n/o,(r=s/o)>=0&&r<=1&&i>=0&&i<d&&(d=i)):0!==n&&0!==s||(i=(y-_)*p+(w-f)*g,i>=0&&i<d&&(d=i),(i=(a-_)*p+(u-f)*g)>=0&&i<d&&(d=i)),y=a,w=u;return d}},n.circle=function(t,e,i){this.x=t,this.y=e,this.radius=i,this.points=[];for(var n,r=0;r<16;r+=2)n=r*Math.PI/8,this.points[r]=this.x+Math.sin(n)*i,this.points[r+1]=this.y+Math.cos(n)*i},n.circle.prototype={containsPoint:function(t,e){var i=this.radius,n=this.x-t,r=this.y-e;return n*n+r*r<i*i},shift:function(t,e){this.x+=t,this.y+=e;for(var i=0,n=this.points,r=n.length;i<r;i+=2)n[i]+=t,n[i+1]+=e},rotate:function(){}},n.matrix=function(t){this.mtx=t,this.width=t[0].length,this.height=t.length},n.matrix.prototype={x:function(t){if(this.width===t.height){for(var e=[],i=0;i<this.height;i++){e[i]=[];for(var r=0;r<t.width;r++){for(var s=0,o=0;o<this.width;o++)s+=this.mtx[i][o]*t.mtx[o][r];e[i][r]=s}}return new n.matrix(e)}},e:function(t,e){return t<1||t>this.mtx.length||e<1||e>this.mtx[0].length?null:this.mtx[t-1][e-1]}}},{"../core/core.js":9,"./spatial-grid.js":50}],45:[function(t,e,i){var n=t("../core/core.js"),r=Math.PI/180;n.extend({raycast:function(t,e){for(var i,r,s="obj",a=1/0,h=!0,u=2,c=arguments.length;u<c;++u)i=arguments[u],r=void 0===i?"undefined":o(i),"number"===r?a=i+1e-6:"string"===r?s=i:"boolean"===r&&(h=i);var l=t._x,d=t._y,_=e.x,p=e.y,f={},g=[];if(a<0){var m=null,v=1/0;n.map.traverseRay(t,e,function(i,n){if(m&&v<n)return g.push({obj:m,distance:v,x:l+v*_,y:d+v*p}),m=null,v=1/0,!0;if(i.map&&i.__c[s]&&!f[i[0]]){f[i[0]]=!0;var r=i.map.intersectRay(t,e);r<v&&(m=i,v=r)}}),m&&g.push({obj:m,distance:v,x:l+v*_,y:d+v*p})}else n.map.traverseRay(t,e,function(i,n){if(n>a)return!0;if(i.map&&i.__c[s]&&!f[i[0]]){f[i[0]]=!0;var r=i.map.intersectRay(t,e);r<a&&g.push({obj:i,distance:r,x:l+r*_,y:d+r*p})}});return h&&g.sort(function(t,e){return t.distance-e.distance}),g}}),n.c("Collision",{init:function(){this.requires("2D"),this._collisionData={},this.collision()},remove:function(){this._cbr=null,this.unbind("Resize",this._resizeMap),this.unbind("Resize",this._checkBounds)},collision:function(t){if(this.unbind("Resize",this._resizeMap),this.unbind("Resize",this._checkBounds),t){if(arguments.length>1){var e=Array.prototype.slice.call(arguments,0);t=new n.polygon(e)}else t=t.constructor===Array?new n.polygon(t.slice()):t.clone();this._findBounds(t.points)}else t=new n.polygon([0,0,this._w,0,this._w,this._h,0,this._h]),this.bind("Resize",this._resizeMap),this._cbr=null;return this.rotation&&t.rotate({cos:Math.cos(-this.rotation*r),sin:Math.sin(-this.rotation*r),o:{x:this._origin.x,y:this._origin.y}}),this.map=t,this.attach(this.map),this.map.shift(this._x,this._y),this.trigger("NewHitbox",t),this},cbr:function(t){return t=t||{},this._cbr?(t._x=this._cbr._x,t._y=this._cbr._y,t._w=this._cbr._w,t._h=this._cbr._h,t):this.mbr(t)},_findBounds:function(t){for(var e=1/0,i=-1/0,n=1/0,r=-1/0,s=t.length,o=0;o<s;o+=2)t[o]<e&&(e=t[o]),t[o]>i&&(i=t[o]),t[o+1]<n&&(n=t[o+1]),t[o+1]>r&&(r=t[o+1]);var a={cx:(e+i)/2,cy:(n+r)/2,r:Math.sqrt((i-e)*(i-e)+(r-n)*(r-n))/2};return e>=0&&n>=0&&(this._checkBounds=function(){null===this._cbr&&this._w<i||this._h<r?(this._cbr=a,this._calculateMBR()):this._cbr&&(this._cbr=null,this._calculateMBR())},this.bind("Resize",this._checkBounds)),e>=0&&n>=0&&i<=this._w&&r<=this._h?(this._cbr=null,!1):(this._cbr=a,this._calculateMBR(),!0)},_resizeMap:function(t){var e,i,n=this.rotation*r,s=this.map.points;"w"===t.axis?(n?(e=t.amount*Math.cos(n),i=t.amount*Math.sin(n)):(e=t.amount,i=0),s[2]+=e,s[3]+=i):(n?(i=t.amount*Math.cos(n),e=-t.amount*Math.sin(n)):(e=0,i=t.amount),s[6]+=e,s[7]+=i),s[4]+=e,s[5]+=i},hit:function(t){var e,i,r,s,o=this._cbr||this._mbr||this,a=n.map.search(o,!1),h=0,u=a.length,c={},l=n.rectManager.overlap,d="map"in this&&"containsPoint"in this.map,_=[];if(!u)return null;for(;h<u;++h)i=a[h],r=i._cbr||i._mbr||i,i&&(e=i[0],!c[e]&&this[0]!==e&&i.__c[t]&&l(r,o)&&(c[e]=i));for(s in c)if(i=c[s],d&&"map"in i){var p=this._SAT(this.map,i.map);p.obj=i,p.type="SAT",p&&_.push(p)}else _.push({obj:i,type:"MBR"});return _.length?_:null},onHit:function(t,e,i){var n=!1;return this.bind("EnterFrame",function(){var r=this.hit(t);r?(e.call(this,r,!n),n=!0):n&&("function"==typeof i&&i.call(this),n=!1)}),this},_createCollisionHandler:function(t,e){return function(){var i=this.hit(t);if(!0===e.occurring){if(null!==i)return;e.occurring=!1,this.trigger("HitOff",t)}else null!==i&&(e.occurring=!0,this.trigger("HitOn",i))}},checkHits:function(){var t=arguments,e=0;for(1===t.length&&(t=t[0].split(/\s*,\s*/));e<t.length;++e){var i=t[e],n=this._collisionData[i];void 0===n&&(this._collisionData[i]=n={occurring:!1,handler:null},n.handler=this._createCollisionHandler(i,n),this.bind("EnterFrame",n.handler))}return this},ignoreHits:function(){var t,e=arguments,i=0;if(0===e.length){for(t in this._collisionData)this.unbind("EnterFrame",t.handler);this._collisionData={}}for(1===e.length&&(e=e[0].split(/\s*,\s*/));i<e.length;++i){var n=e[i];t=this._collisionData[n],void 0!==t&&(this.unbind("EnterFrame",t.handler),delete this._collisionData[n])}return this},resetHitChecks:function(){var t,e=arguments,i=0;if(0===e.length)for(t in this._collisionData)this._collisionData[t].occurring=!1;for(1===e.length&&(e=e[0].split(/\s*,\s*/));i<e.length;++i){var n=e[i];t=this._collisionData[n],void 0!==t&&(t.occurring=!1)}return this},_SAT:function(t,e){for(var i,n,r,s,o,a,h,u,c,l=0,d=t.points,_=e.points,p=d.length/2,f=_.length/2,g=0,m=0,v=-1/0,y=null,w=null;l<p;l++){for(c=l===p-1?0:l+1,g=-(d[2*l+1]-d[2*c+1]),m=d[2*l]-d[2*c],n=Math.sqrt(g*g+m*m),g/=n,m/=n,r=s=1/0,o=a=-1/0,i=0;i<p;++i)u=d[2*i]*g+d[2*i+1]*m,u>o&&(o=u),u<r&&(r=u);for(i=0;i<f;++i)u=_[2*i]*g+_[2*i+1]*m,u>a&&(a=u),u<s&&(s=u);if(r<s?(h=s-o,g=-g,m=-m):h=r-a,h>=0)return!1;h>v&&(v=h,y=g,w=m)}for(l=0;l<f;l++){for(c=l===f-1?0:l+1,g=-(_[2*l+1]-_[2*c+1]),m=_[2*l]-_[2*c],n=Math.sqrt(g*g+m*m),g/=n,m/=n,r=s=1/0,o=a=-1/0,i=0;i<p;++i)u=d[2*i]*g+d[2*i+1]*m,u>o&&(o=u),u<r&&(r=u);for(i=0;i<f;++i)u=_[2*i]*g+_[2*i+1]*m,u>a&&(a=u),u<s&&(s=u);if(r<s?(h=s-o,g=-g,m=-m):h=r-a,h>=0)return!1;h>v&&(v=h,y=g,w=m)}return{overlap:v,normal:{x:y,y:w}}}})},{"../core/core.js":9}],46:[function(t,e,i){var n=t("../core/core.js");n.math={abs:function(t){return t<0?-t:t},amountOf:function(t,e,i){return e<i?(t-e)/(i-e):(t-i)/(e-i)},clamp:function(t,e,i){return t>i?i:t<e?e:t},degToRad:function(t){return t*Math.PI/180},distance:function(t,e,i,r){var s=n.math.squaredDistance(t,e,i,r);return Math.sqrt(parseFloat(s))},lerp:function(t,e,i){return t+(e-t)*i},negate:function(t){return Math.random()<t?-1:1},radToDeg:function(t){return 180*t/Math.PI},randomElementOfArray:function(t){return t[Math.floor(t.length*Math.random())]},randomInt:function(t,e){return t+Math.floor((1+e-t)*Math.random())},randomNumber:function(t,e){return t+(e-t)*Math.random()},squaredDistance:function(t,e,i,n){return(t-i)*(t-i)+(e-n)*(e-n)},withinRange:function(t,e,i){return t>=e&&t<=i}},n.math.Vector2D=function(){function t(e,i){if(e instanceof t)this.x=e.x,this.y=e.y;else if(2===arguments.length)this.x=e,this.y=i;else if(arguments.length>0)throw"Unexpected number of arguments for Vector2D()"}return t.prototype.x=0,t.prototype.y=0,t.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this},t.prototype.angleBetween=function(t){return Math.atan2(this.x*t.y-this.y*t.x,this.x*t.x+this.y*t.y)},t.prototype.angleTo=function(t){return Math.atan2(t.y-this.y,t.x-this.x)},t.prototype.clone=function(){return new t(this)},t.prototype.distance=function(t){return Math.sqrt((t.x-this.x)*(t.x-this.x)+(t.y-this.y)*(t.y-this.y))},t.prototype.distanceSq=function(t){return(t.x-this.x)*(t.x-this.x)+(t.y-this.y)*(t.y-this.y)},t.prototype.divide=function(t){return this.x/=t.x,this.y/=t.y,this},t.prototype.dotProduct=function(t){return this.x*t.x+this.y*t.y},t.prototype.crossProduct=function(t){return this.x*t.y-this.y*t.x},t.prototype.equals=function(e){return e instanceof t&&this.x===e.x&&this.y===e.y},t.prototype.perpendicular=function(e){return e=e||new t,e.setValues(-this.y,this.x)},t.prototype.getNormal=function(e,i){return i=i||new t,i.setValues(e.y-this.y,this.x-e.x).normalize()},t.prototype.isZero=function(){return 0===this.x&&0===this.y},t.prototype.magnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},t.prototype.magnitudeSq=function(){return this.x*this.x+this.y*this.y},t.prototype.multiply=function(t){return this.x*=t.x,this.y*=t.y,this},t.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},t.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y);return 0===t?(this.x=1,this.y=0):(this.x/=t,this.y/=t),this},t.prototype.scale=function(t,e){return void 0===e&&(e=t),this.x*=t,this.y*=e,this},t.prototype.scaleToMagnitude=function(t){var e=t/this.magnitude();return this.x*=e,this.y*=e,this},t.prototype.setValues=function(e,i){return e instanceof t?(this.x=e.x,this.y=e.y):(this.x=e,this.y=i),this},t.prototype.subtract=function(t){return this.x-=t.x,this.y-=t.y,this},t.prototype.toString=function(){return"Vector2D("+this.x+", "+this.y+")"},t.prototype.translate=function(t,e){return void 0===e&&(e=t),this.x+=t,this.y+=e,this},t.tripleProduct=function(t,e,i,r){r=r||new n.math.Vector2D;var s=t.dotProduct(i),o=e.dotProduct(i);return r.setValues(e.x*s-t.x*o,e.y*s-t.y*o)},t}(),n.math.Matrix2D=function(){function t(e,i,n,r,s,o){if(e instanceof t)this.a=e.a,this.b=e.b,this.c=e.c,this.d=e.d,this.e=e.e,this.f=e.f;else if(6===arguments.length)this.a=e,this.b=i,this.c=n,this.d=r,this.e=s,this.f=o;else if(arguments.length>0)throw"Unexpected number of arguments for Matrix2D()"}return t.prototype.a=1,t.prototype.b=0,t.prototype.c=0,t.prototype.d=1,t.prototype.e=0,t.prototype.f=0,t.prototype.apply=function(t){var e=t.x;return t.x=e*this.a+t.y*this.c+this.e,t.y=e*this.b+t.y*this.d+this.f,t},t.prototype.clone=function(){return new t(this)},t.prototype.combine=function(t){var e=this.a;return this.a=e*t.a+this.b*t.c,this.b=e*t.b+this.b*t.d,e=this.c,this.c=e*t.a+this.d*t.c,this.d=e*t.b+this.d*t.d,e=this.e,this.e=e*t.a+this.f*t.c+t.e,this.f=e*t.b+this.f*t.d+t.f,this},t.prototype.equals=function(e){return e instanceof t&&this.a===e.a&&this.b===e.b&&this.c===e.c&&this.d===e.d&&this.e===e.e&&this.f===e.f},t.prototype.determinant=function(){return this.a*this.d-this.b*this.c},t.prototype.invert=function(){var t=this.determinant();if(0!==t){var e={a:this.a,b:this.b,c:this.c,d:this.d,e:this.e,f:this.f};this.a=e.d/t,this.b=-e.b/t,this.c=-e.c/t,this.d=e.a/t,this.e=(e.c*e.f-e.e*e.d)/t,this.f=(e.e*e.b-e.a*e.f)/t}return this},t.prototype.isIdentity=function(){return 1===this.a&&0===this.b&&0===this.c&&1===this.d&&0===this.e&&0===this.f},t.prototype.isInvertible=function(){return 0!==this.determinant()},t.prototype.preRotate=function(t){var e=Math.cos(t),i=Math.sin(t),n=this.a;return this.a=e*n-i*this.b,this.b=i*n+e*this.b,n=this.c,this.c=e*n-i*this.d,this.d=i*n+e*this.d,this},t.prototype.preScale=function(t,e){return void 0===e&&(e=t),this.a*=t,this.b*=e,this.c*=t,this.d*=e,this},t.prototype.preTranslate=function(t,e){return"number"==typeof t?(this.e+=t,this.f+=e):(this.e+=t.x,this.f+=t.y),this},t.prototype.rotate=function(t){var e=Math.cos(t),i=Math.sin(t),n=this.a;return this.a=e*n-i*this.b,this.b=i*n+e*this.b,n=this.c,this.c=e*n-i*this.d,this.d=i*n+e*this.d,n=this.e,this.e=e*n-i*this.f,this.f=i*n+e*this.f,this},t.prototype.scale=function(t,e){return void 0===e&&(e=t),this.a*=t,this.b*=e,this.c*=t,this.d*=e,this.e*=t,this.f*=e,this},t.prototype.setValues=function(e,i,n,r,s,o){return e instanceof t?(this.a=e.a,this.b=e.b,this.c=e.c,this.d=e.d,this.e=e.e,this.f=e.f):(this.a=e,this.b=i,this.c=n,this.d=r,this.e=s,this.f=o),this},t.prototype.toString=function(){return"Matrix2D(["+this.a+", "+this.c+", "+this.e+"] ["+this.b+", "+this.d+", "+this.f+"] [0, 0, 1])"},t.prototype.translate=function(t,e){return"number"==typeof t?(this.e+=this.a*t+this.c*e,this.f+=this.b*t+this.d*e):(this.e+=this.a*t.x+this.c*t.y,this.f+=this.b*t.x+this.d*t.y),this},t}()},{"../core/core.js":9}],47:[function(t,e,i){var n=t("../core/core.js"),r=function(t,e,i,r){var s=e+i,o="_"+s,a={key:"",oldValue:0};r?n.defineField(t,s,function(){return this[o]},function(t){var e=this[o];t!==e&&(this[o]=t,a.key=s,a.oldValue=e,this.trigger("MotionChange",a))}):n.defineField(t,s,function(){return this[o]},function(t){}),Object.defineProperty(t,o,{value:0,writable:!0,enumerable:!1,configurable:!1})},s=function(t,e,i,r){var s=e+"x",o=e+"y",a="_"+s,h="_"+o;return i?(n.defineField(r,"x",function(){return t[a]},function(e){t[s]=e}),n.defineField(r,"y",function(){return t[h]},function(e){t[o]=e})):(n.defineField(r,"x",function(){return t[a]},function(t){}),n.defineField(r,"y",function(){return t[h]},function(t){})),Object.seal&&Object.seal(r),r};n.c("AngularMotion",{_vrotation:0,_arotation:0,_drotation:0,init:function(){this.requires("2D"),r(this,"v","rotation",!0),r(this,"a","rotation",!0),r(this,"d","rotation",!1),this.__oldRotationDirection=0,this.bind("EnterFrame",this._angularMotionTick)},remove:function(t){this.unbind("EnterFrame",this._angularMotionTick)},resetAngularMotion:function(){return this._drotation=0,this.vrotation=0,this.arotation=0,this},_angularMotionTick:function(t){var e=t.dt/1e3,i=this._rotation,n=this._vrotation,r=this._arotation,s=i+n*e+.5*r*e*e;this.vrotation=n+r*e;var o=this._vrotation,a=o?o<0?-1:1:0;this.__oldRotationDirection!==a&&(this.__oldRotationDirection=a,this.trigger("NewRotationDirection",a)),this._drotation=s-i,0!==this._drotation&&(this.rotation=s,this.trigger("Rotated",i))}}),n.c("Motion",{_vx:0,_vy:0,_ax:0,_ay:0,_dx:0,_dy:0,init:function(){this.requires("2D"),r(this,"v","x",!0),r(this,"v","y",!0),this._velocity=s(this,"v",!0,new n.math.Vector2D),r(this,"a","x",!0),r(this,"a","y",!0),this._acceleration=s(this,"a",!0,new n.math.Vector2D),r(this,"d","x",!1),r(this,"d","y",!1),this._motionDelta=s(this,"d",!1,new n.math.Vector2D),this.__movedEvent={axis:"",oldValue:0},this.__oldDirection={x:0,y:0},this.bind("EnterFrame",this._linearMotionTick)},remove:function(t){this.unbind("EnterFrame",this._linearMotionTick)},resetMotion:function(){return this.vx=0,this.vy=0,this.ax=0,this.ay=0,this._dx=0,this._dy=0,this},motionDelta:function(){return this._motionDelta},velocity:function(){return this._velocity},acceleration:function(){return this._acceleration},ccdbr:function(t){var e=this._cbr||this._mbr||this,i=this._dx,n=this._dy,r=0,s=0,o=i>0?r=i:-i,a=n>0?s=n:-n;return t=t||{},t._x=e._x-r,t._y=e._y-s,t._w=e._w+o,t._h=e._h+a,t},_linearMotionTick:function(t){var e=t.dt/1e3,i=this._x,n=this._vx,r=this._ax,s=this._y,o=this._vy,a=this._ay,h=i+n*e+.5*r*e*e,u=s+o*e+.5*a*e*e;this.vx=n+r*e,this.vy=o+a*e;var c=this.__oldDirection,l=this._vx,d=l?l<0?-1:1:0,_=this._vy,p=_?_<0?-1:1:0;c.x===d&&c.y===p||(c.x=d,c.y=p,this.trigger("NewDirection",c));var f=this.__movedEvent;this._dx=h-i,this._dy=u-s,0!==this._dx&&(this.x=h,f.axis="x",f.oldValue=i,this.trigger("Moved",f)),0!==this._dy&&(this.y=u,f.axis="y",f.oldValue=s,this.trigger("Moved",f))}})},{"../core/core.js":9}],48:[function(t,e,i){var n=t("../core/core.js");n.c("Supportable",{_ground:null,_groundComp:null,_preventGroundTunneling:!1,canLand:!0,init:function(){this.requires("2D"),this.__area={_x:0,_y:0,_w:0,_h:0},this.defineField("ground",function(){return this._ground},function(t){})},remove:function(t){this.unbind("EnterFrame",this._detectGroundTick)},startGroundDetection:function(t){return t&&(this._groundComp=t),this.uniqueBind("EnterFrame",this._detectGroundTick),this},stopGroundDetection:function(){return this.unbind("EnterFrame",this._detectGroundTick),this},preventGroundTunneling:function(t){return void 0===t&&(t=!0),t&&this.requires("Motion"),this._preventGroundTunneling=t,this},_detectGroundTick:function(){var t,e=this._groundComp,i=this._ground,r=n.rectManager.overlap;if(this._preventGroundTunneling)t=this.ccdbr(this.__area);else{var s=this._cbr||this._mbr||this;t=this.__area,t._x=s._x,t._y=s._y,t._w=s._w,t._h=s._h}if(t._h++,i){var o=i._cbr||i._mbr||i;i.__c[e]&&n(i[0])===i&&r(o,t)||(this._ground=null,this.trigger("LiftedOffGround",i),i=null)}if(!i)for(var a,h,u=n.map.search(t,!1),c=0,l=u.length;c<l;++c)if(a=u[c],h=a._cbr||a._mbr||a,a!==this&&a.__c[e]&&r(h,t)&&(this.canLand=!0,this.trigger("CheckLanding",a),this.canLand)){this._ground=i=a,this.y=i._y-this._h,this._x>i._x+i._w?this.x=i._x+i._w-1:this._x+this._w<i._x&&(this.x=i._x-this._w+1),this.trigger("LandedOnGround",i);break}}}),n.c("GroundAttacher",{_groundAttach:function(t){t.attach(this)},_groundDetach:function(t){t.detach(this)},init:function(){this.requires("Supportable"),this.bind("LandedOnGround",this._groundAttach),this.bind("LiftedOffGround",this._groundDetach)},remove:function(t){this.unbind("LandedOnGround",this._groundAttach),this.unbind("LiftedOffGround",this._groundDetach)}}),n.c("Gravity",{_gravityConst:500,_gravityActive:!1,init:function(){this.requires("2D, Supportable, Motion"),this.bind("LiftedOffGround",this._startGravity),this.bind("LandedOnGround",this._stopGravity)},remove:function(t){this.unbind("LiftedOffGround",this._startGravity),this.unbind("LandedOnGround",this._stopGravity)},_gravityCheckLanding:function(t){this._dy<0&&(this.canLand=!1)},gravity:function(t){return this.uniqueBind("CheckLanding",this._gravityCheckLanding),this.startGroundDetection(t),this._startGravity(),this},antigravity:function(){return this._stopGravity(),this.stopGroundDetection(),this.unbind("CheckLanding",this._gravityCheckLanding),this},gravityConst:function(t){return this._gravityActive&&(this.ay-=this._gravityConst,this.ay+=t),this._gravityConst=t,this},_startGravity:function(){this._gravityActive||(this._gravityActive=!0,this.ay+=this._gravityConst)},_stopGravity:function(){this._gravityActive&&(this._gravityActive=!1,this.ay=0,this.vy=0)}})},{"../core/core.js":9}],49:[function(t,e,i){t("../core/core.js").extend({rectManager:{merge:function(t,e,i){return void 0===i&&(i={}),i._h=Math.max(t._y+t._h,e._y+e._h),i._w=Math.max(t._x+t._w,e._x+e._w),i._x=Math.min(t._x,e._x),i._y=Math.min(t._y,e._y),i._w-=i._x,i._h-=i._y,i},overlap:function(t,e){return t._x<e._x+e._w&&t._x+t._w>e._x&&t._y<e._y+e._h&&t._y+t._h>e._y},integerBounds:function(t){return t._w=t._x+t._w,t._h=t._y+t._h,t._x=t._x>0?0|t._x:(0|t._x)-1,t._y=t._y>0?0|t._y:(0|t._y)-1,t._w-=t._x,t._h-=t._y,t._w=t._w===(0|t._w)?t._w:1+(0|t._w),t._h=t._h===(0|t._h)?t._h:1+(0|t._h),t},mergeSet:function(t){for(var e=0;e<t.length-1;)this.overlap(t[e],t[e+1])?(this.merge(t[e],t[e+1],t[e]),t.splice(e+1,1),e>0&&e--):e++;return t},boundingRect:function(t){if(t&&t.length){var e,i,n=1,r=t.length,s=t[0];for(s=[s._x,s._y,s._x+s._w,s._y+s._h];n<r;)e=t[n],i=[e._x,e._y,e._x+e._w,e._y+e._h],i[0]<s[0]&&(s[0]=i[0]),i[1]<s[1]&&(s[1]=i[1]),i[2]>s[2]&&(s[2]=i[2]),i[3]>s[3]&&(s[3]=i[3]),n++;return i=s,s={_x:i[0],_y:i[1],_w:i[2]-i[0],_h:i[3]-i[1]}}},_pool:function(){var t=[],e=0;return{get:function(i,n,r,s){t.length<=e&&t.push({});var o=t[e++];return o._x=i,o._y=n,o._w=r,o._h=s,o},copy:function(i){t.length<=e&&t.push({});var n=t[e++];return n._x=i._x,n._y=i._y,n._w=i._w,n._h=i._h,n},recycle:function(t){e--}}}()}})},{"../core/core.js":9}],50:[function(t,e,i){function n(t,e,i){this.keys=t,this.map=i,this.obj=e}var r,s=function(t){r=t||64,this.map={},this.boundsDirty=!1,this.boundsHash={max:{x:-1/0,y:-1/0},min:{x:1/0,y:1/0}},this.boundsCoords={max:{x:-1/0,y:-1/0},min:{x:1/0,y:1/0}}},a={};s.prototype={insert:function(t){var e,i,r=s.key(t),o=new n(r,t,this),a=0;for(a=r.x1;a<=r.x2;a++)for(e=r.y1;e<=r.y2;e++)i=a<<16^e,this.map[i]||(this.map[i]=[]),this.map[i].push(t);return this.boundsDirty=!0,o},search:function(t,e){var i,n,r,o,h,u=s.key(t,a),c=[];for(void 0===e&&(e=!0),i=u.x1;i<=u.x2;i++)for(n=u.y1;n<=u.y2;n++)if(h=this.map[i<<16^n])for(r=0;r<h.length;r++)c.push(h[r]);if(e){var l,d,_=[],p={};for(i=0,o=c.length;i<o;i++)(l=c[i])&&(d=l[0],l=l._cbr||l._mbr||l,!p[d]&&l._x<t._x+t._w&&l._x+l._w>t._x&&l._y<t._y+t._h&&l._y+l._h>t._y&&(p[d]=c[i]));for(l in p)_.push(p[l]);return _}return c},remove:function(t){var e,i,n=t.keys,r=t.obj,s=0;for(s=n.x1;s<=n.x2;s++)for(e=n.y1;e<=n.y2;e++)if(i=s<<16^e,this.map[i]){var o,a=this.map[i],h=a.length;for(o=0;o<h;o++)a[o]&&a[o][0]===r[0]&&a.splice(o,1)}this.boundsDirty=!0},refresh:function(t){var e,i,n,r,o,a=t.keys,h=t.obj;for(i=a.x1;i<=a.x2;i++)for(n=a.y1;n<=a.y2;n++)if(e=this.map[i<<16^n])for(o=e.length,r=0;r<o;r++)e[r]&&e[r][0]===h[0]&&e.splice(r,1);for(s.key(h,a),i=a.x1;i<=a.x2;i++)for(n=a.y1;n<=a.y2;n++)e=this.map[i<<16^n],e||(e=this.map[i<<16^n]=[]),e.push(h);return this.boundsDirty=!0,t},boundaries:function(){return this._updateBoundaries(),this.boundsCoords},_keyBoundaries:function(){return this._updateBoundaries(),this.boundsHash},_updateBoundaries:function(){if(this.boundsDirty){var t=this.boundsHash;t.max.x=-1/0,t.max.y=-1/0,t.min.x=1/0,t.min.y=1/0;var e=this.boundsCoords;e.max.x=-1/0,e.max.y=-1/0,e.min.x=1/0,e.min.y=1/0;var i,n;for(var r in this.map)if(this.map[r].length){var s=r>>16,a=r<<16>>16;if(a<0&&(s^=-1),s>=t.max.x){t.max.x=s;for(i in this.map[r])n=this.map[r][i],"object"===(void 0===n?"undefined":o(n))&&"requires"in n&&(e.max.x=Math.max(e.max.x,n.x+n.w))}if(s<=t.min.x){t.min.x=s;for(i in this.map[r])n=this.map[r][i],"object"===(void 0===n?"undefined":o(n))&&"requires"in n&&(e.min.x=Math.min(e.min.x,n.x))}if(a>=t.max.y){t.max.y=a;for(i in this.map[r])n=this.map[r][i],"object"===(void 0===n?"undefined":o(n))&&"requires"in n&&(e.max.y=Math.max(e.max.y,n.y+n.h))}if(a<=t.min.y){t.min.y=a;for(i in this.map[r])n=this.map[r][i],"object"===(void 0===n?"undefined":o(n))&&"requires"in n&&(e.min.y=Math.min(e.min.y,n.y))}}this.boundsDirty=!1}},traverseRay:function(t,e,i){var n=e.x,o=e.y;t={_x:t._x,_y:t._y,_w:0,_h:0};var h,u=this._keyBoundaries(),c=s.key(t,a),l=c.x1,d=c.y1,_=u.min.x,p=u.min.y,f=u.max.x,g=u.max.y,m=n>0?1:n<0?-1:0,v=o>0?1:o<0?-1:0,y=n>=0?(l+1)*r:l*r,w=o>=0?(d+1)*r:d*r,x=-1/0,b=0,D=0,C=1/0,T=1/0;for(0!==n&&(h=1/n,C=(y-t._x)*h,b=r*m*h),0!==o&&(h=1/o,T=(w-t._y)*h,D=r*v*h);1===m&&l<_&&_!==1/0||-1===m&&l>f&&f!==-1/0||1===v&&d<p&&p!==1/0||-1===v&&d>g&&g!==-1/0;)C<T?(x=C,l+=m,C+=b):(x=T,d+=v,T+=D);for(var R;_<=l&&l<=f&&p<=d&&d<=g;){if(R=this.map[l<<16^d])for(var M=0;M<R.length;M++)if(i(R[M],x))return;C<T?(x=C,l+=m,C+=b):(x=T,d+=v,T+=D)}}},s.key=function(t,e){return t=t._cbr||t._mbr||t,e=e||{},e.x1=Math.floor(t._x/r),e.y1=Math.floor(t._y/r),e.x2=Math.floor((t._w+t._x)/r),e.y2=Math.floor((t._h+t._y)/r),e},s.hash=function(t){return t.x1+" "+t.y1+" "+t.x2+" "+t.y2},n.prototype={update:function(t){s.hash(s.key(t,a))!==s.hash(this.keys)&&this.map.refresh(this)}},e.exports=s},{}]},{},[19])}});